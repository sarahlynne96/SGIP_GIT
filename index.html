<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SGIP Incentive Calculator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    :root {
      --primary: #fdb813;
      --navy: #003c71;
      --accent: #005eb8;
      --border: #e2e8f0;
      --bg-card: #fff;
      --shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.18);
      --radius: 8px;
      --font-sm: 0.875rem;
      --font-base: 1rem;
      --font-lg: 1.25rem;
      --font-xl: 1.75rem;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f9fafb;
      color: #111;
      font-size: var(--font-base);
    }

    header {
      background: var(--primary);
      color: #000;
      padding: 1rem;
      font-size: var(--font-xl);
      text-align: center;
      font-weight: bold;
    }

    main {
      max-width: 960px;
      margin: auto;
      padding: 1rem;
    }

    section.card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    h2 {
      color: var(--navy);
      font-size: var(--font-lg);
    }

    label {
      display: block;
      margin: 0.75rem 0 0.25rem;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      font-size: var(--font-base);
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    input:focus, select:focus {
      outline: 2px solid var(--accent);
    }

    .button-group {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    button {
      min-height: 44px;
      padding: 0 1rem;
      font-size: var(--font-base);
      border-radius: 4px;
      border: 2px solid transparent;
      cursor: pointer;
    }

    button.primary {
      background: var(--primary);
      color: #000;
      border-color: var(--primary);
    }

    button.secondary {
      background: #fff;
      border-color: var(--primary);
      color: var(--primary);
    }

    button:focus {
      outline: 2px solid var(--accent);
    }

    .pill {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: var(--navy);
      color: #fff;
      border-radius: 999px;
      font-size: var(--font-sm);
      margin: 0.25rem 0;
    }

    .pill.pending {
      background: #ccc;
      color: #000;
    }

    .error {
      color: red;
      font-size: var(--font-sm);
    }

    #map {
      height: 300px;
      margin-top: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    @media (min-width: 768px) {
      .button-group {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>SGIP Eligibility & Incentive Calculator</header>
  <main>
    <section class="card" id="form-section">
      <h2>Eligibility & Incentive Form</h2>
      <form id="calc-form">
        <label for="address">Service Address</label>
        <input type="text" id="address" name="address" required />

        <label for="zip">ZIP Code</label>
        <input type="text" id="zip" name="zip" maxlength="5" />

        <label for="income">Household Income</label>
        <input type="number" id="income" name="income" />

        <label for="customer-class">Customer Class *</label>
        <select id="customer-class" required>
          <option value="">Select</option>
          <option value="residential">Residential</option>
          <option value="small-business">Small Business</option>
        </select>
        <div class="error" id="customer-error"></div>

        <label for="kwh">Battery Capacity (kWh) *</label>
        <input type="number" id="kwh" required />
        <div class="error" id="kwh-error"></div>

        <label for="kw">Solar Size (kW)</label>
        <input type="number" id="kw" />

        <label for="utility">Utility</label>
        <select id="utility">
          <option value="">Select</option>
          <option value="PGE">PG&E</option>
          <option value="SCE">SCE</option>
          <option value="SDGE">SDG&E</option>
          <option value="SCG">SoCalGas</option>
        </select>

        <div class="button-group">
          <button type="submit" class="primary">Calculate Incentives</button>
          <button type="button" class="secondary" id="export-pdf">Export PDF</button>
        </div>
        <div role="status" aria-live="polite" id="status-pill" class="pill pending">Status: Not calculated</div>
      </form>
    </section>

    <section class="card" id="results-section">
      <h2>Results</h2>
      <div>Storage Incentive: <strong id="storage-result">—</strong></div>
      <div>Solar Incentive: <strong id="solar-result">—</strong></div>
      <div class="pill" id="total-pill">Total: —</div>
      <div id="badges">
        <div class="pill" id="dac-pill">DAC: —</div>
        <div class="pill" id="fire-pill">Fire Zone: —</div>
        <div class="pill" id="psps-pill">PSPS: —</div>
        <div class="pill" id="ami-pill">AMI: —</div>
      </div>
    </section>

    <section class="card" id="budget-section">
      <h2>Statewide SGIP Budgets</h2>
      <div>RSSE – Ratepayer: <span id="ratepayer-budget">—</span></div>
      <div>RSSE – AB 209: <span id="ab209-budget">—</span></div>
      <div>Small-Residential Storage: <span id="smallres-budget">—</span></div>
    </section>

    <section class="card">
      <h2>Map Preview</h2>
      <div id="map"></div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // Helpers
    const timeoutFetch = (url, opts = {}, timeout = 15000) =>
      Promise.race([
        fetch(url, opts),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout)),
      ]);

    const $ = id => document.getElementById(id);

    const formatMoney = n => n ? `$${Number(n).toLocaleString()}` : '—';

    // State
    let lat, lon;

    const cacheResult = (address, data) => {
      localStorage.setItem(`addr:${address}`, JSON.stringify(data));
    };

    const loadCached = address => {
      const data = localStorage.getItem(`addr:${address}`);
      return data ? JSON.parse(data) : null;
    };

    // Geocode and Layer Checks
    async function fetchAddress(address) {
      const cached = loadCached(address);
      if (cached) return cached;

      const res = await timeoutFetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?SingleLine=${encodeURIComponent(address)}&f=json`);
      const json = await res.json();
      const candidate = json.candidates[0];
      if (!candidate) throw new Error("Address not found");
      lat = candidate.location.y;
      lon = candidate.location.x;
      return { lat, lon };
    }

    async function pointInPolygon(lat, lon, url) {
      const q = `${url}?geometry=${lon},${lat}&geometryType=esriGeometryPoint&spatialRel=esriSpatialRelIntersects&f=json`;
      const res = await timeoutFetch(q);
      const json = await res.json();
      return json.features.length > 0;
    }

    async function fetchLayers() {
      const dac = await pointInPolygon(lat, lon, 'https://services1.arcgis.com/PCHfdHz4GlDNAhBb/ArcGIS/rest/services/SB_535_Disadvantaged_Communities_2022/FeatureServer/0/query');
      const fireT3 = await pointInPolygon(lat, lon, 'https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/0/query');
      const fireT2 = await pointInPolygon(lat, lon, 'https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/1/query');
      const psps = await pointInPolygon(lat, lon, 'https://services2.arcgis.com/VofPZYDe2pLxSP5G/arcgis/rest/services/Consolidated_PSPS_Map20221231_gdb/FeatureServer/0/query');
      return { dac, fire: fireT3 || fireT2, psps };
    }

    async function fetchAMI(zip, income) {
      const res = await timeoutFetch(`https://www.huduser.gov/hudapi/public/il/v2/zip/${zip}?year=2024`, {
        headers: { 'Accept': 'application/json' }
      });
      const json = await res.json();
      const mfi = json?.IncomeLimits?.[0]?.medianFamilyIncome;
      if (mfi && income) {
        const ami = (income / mfi) * 100;
        return Math.round(ami);
      }
      return null;
    }

    async function fetchBudgets() {
      try {
        const res = await timeoutFetch('https://www.selfgenca.com/home/program_metrics/');
        const html = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const rows = Array.from(doc.querySelectorAll("table tr"));
        const findTotal = title => {
          const row = rows.find(r => r.innerText.includes(title));
          if (!row) return null;
          const cells = row.querySelectorAll("td");
          let total = 0;
          for (let i = 1; i <= 4; i++) {
            total += parseFloat(cells[i].innerText.replace(/[^0-9.]/g, "")) || 0;
          }
          return `$${Math.round(total).toLocaleString()}`;
        };
        $("ratepayer-budget").innerText = findTotal("Residential Solar & Storage Equity – Ratepayer") || "—";
        $("ab209-budget").innerText = findTotal("Residential Solar & Storage Equity – AB 209") || "—";
        $("smallres-budget").innerText = findTotal("Small Residential Storage") || "—";
      } catch (e) {
        $("ratepayer-budget").innerText = "—";
        $("ab209-budget").innerText = "—";
        $("smallres-budget").innerText = "—";
      }
    }

    // PDF Export
    $("export-pdf").onclick = () => {
      const html = `
        <html><head><title>SGIP Results</title></head><body>
        <h1>SGIP Incentive Summary</h1>
        <p>${$("storage-result").innerText}</p>
        <p>${$("solar-result").innerText}</p>
        <p>${$("total-pill").innerText}</p>
        </body><script>window.print()</script></html>`;
      const w = window.open();
      w.document.write(html);
      w.document.close();
    };

    // Leaflet map
    const map = L.map('map').setView([37.8, -122.4], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let marker;

    // Main handler
    $("calc-form").onsubmit = async e => {
      e.preventDefault();
      $("customer-error").innerText = "";
      $("kwh-error").innerText = "";

      const kwh = parseFloat($("kwh").value);
      const kw = parseFloat($("kw").value) || 0;
      const income = parseFloat($("income").value);
      const address = $("address").value;
      const zip = $("zip").value;
      const customerClass = $("customer-class").value;
      const utility = $("utility").value;

      if (!customerClass) return $("customer-error").innerText = "Customer class required.";
      if (!kwh || kwh <= 0) return $("kwh-error").innerText = "Battery capacity must be greater than 0.";

      $("status-pill").innerText = "Status: Calculating...";

      try {
        const addr = await fetchAddress(address);
        lat = addr.lat;
        lon = addr.lon;

        if (marker) map.removeLayer(marker);
        map.setView([lat, lon], 13);
        marker = L.marker([lat, lon]).addTo(map);

        const layers = await fetchLayers();
        $("dac-pill").innerText = "DAC: " + (layers.dac ? "✔" : "✘");
        $("fire-pill").innerText = "Fire Zone: " + (layers.fire ? "✔" : "✘");
        $("psps-pill").innerText = "PSPS: " + (layers.psps ? "✔" : "✘");

        if (zip && income) {
          const ami = await fetchAMI(zip, income);
          $("ami-pill").innerText = "AMI: " + (ami ? ami + "%" : "—");
        }

        const storageIncentive = kwh * 1000 * 1.10;
        const solarIncentive = kw * 3100;
        $("storage-result").innerText = formatMoney(storageIncentive);
        $("solar-result").innerText = formatMoney(solarIncentive);
        $("total-pill").innerText = "Total: " + formatMoney(storageIncentive + solarIncentive);

        const today = new Date();
        const gateDate = new Date("2025-05-20");
        if (["PGE", "SCE", "SDGE", "SCG"].includes(utility) && today < gateDate) {
          $("status-pill").innerText = "Status: PENDING";
        } else {
          $("status-pill").innerText = "Status: ELIGIBLE";
        }

        cacheResult(address, { lat, lon, ...layers, utility });
      } catch (err) {
        $("status-pill").innerText = "Error: " + err.message;
      }
    };

    fetchBudgets();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SGIP Residential Solar & Storage Equity Calculator</title>

<!-- Leaflet (mini-map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<style>
/* ---------- DESIGN TOKENS (matches CPUC fact-sheet) ---------- */
:root{
  --primary:#fdb813;        /* orange bar / buttons */
  --primary-dark:#fca61e;
  --secondary:#003c71;      /* headings */
  --accent:#005eb8;         /* links / focus ring */
  --bg:#f5f5f5;             /* page bg */
  --surface:#ffffff;        /* cards */
  --border:#e2e8f0;         /* card border */
  --text:#222;
  --muted:#555;
  --error:#c53030;
  --radius:8px;
  --shadow:0 2px 6px -2px rgb(0 0 0 / .18);

  --fs-sm:.875rem;
  --fs-base:1rem;
  --fs-lg:1.25rem;
  --fs-xl:1.75rem;
}
*,*::before,*::after{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
/* ---------- HEADER ---------- */
header{
  background:var(--primary);
  padding:1.5rem 1rem;
  box-shadow:var(--shadow);
}
header h1{
  margin:0 auto;max-width:1080px;text-align:center;font-size:var(--fs-xl);font-weight:700;color:#000;line-height:1.2;
}
/* ---------- LAYOUT ---------- */
.container{
  max-width:1080px;margin:auto;padding:2rem 1rem 3.5rem;display:flex;flex-direction:column;gap:2.25rem;
}
.card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1.5rem 1.75rem;
}
h2.section{margin:.2rem 0 1.2rem;font-size:var(--fs-lg);color:var(--secondary)}
h3{margin:1.1rem 0 .7rem;color:var(--secondary);font-size:var(--fs-base);font-weight:600}
label{display:block;margin-bottom:.4rem;color:var(--secondary);font-weight:600}
input,select{
  width:100%;padding:.65rem .75rem;font-size:var(--fs-base);border:1px solid var(--border);border-radius:6px;background:#fff;color:inherit;
}
input:focus,select:focus{border-color:var(--accent);outline:2px solid var(--accent)}
.help{font-size:var(--fs-sm);color:var(--muted);margin-top:.35rem}
.error{color:var(--error);font-size:var(--fs-sm);margin-top:.35rem}
.actions{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:1.2rem}
button{
  cursor:pointer;border:none;border-radius:6px;min-height:44px;padding:.65rem 1rem;font-size:var(--fs-base);transition:filter .15s;
}
.primary{background:var(--primary);color:#000}
.primary:hover{filter:brightness(1.07)}
.secondary{background:#fff;border:1px solid var(--border)}
.secondary:hover{background:#f1f5f9}
.badge{display:inline-block;padding:.15rem .55rem;border-radius:9999px;background:var(--primary);font-size:.75rem;font-weight:600;margin-right:.25rem}
.pill{display:inline-block;border-radius:9999px;padding:.18rem .55rem;font-size:.75rem;font-weight:700;color:#fff}
.open{background:#16a34a}.pending{background:#f59e0b;color:#000}.closed{background:#dc2626}
table.budget{width:100%;border-collapse:collapse;margin:1rem 0 .75rem}
table.budget th,table.budget td{border:1px solid var(--border);padding:.5rem .6rem;font-size:var(--fs-sm);text-align:left}
table.budget thead{background:var(--secondary);color:#fff}
#result{white-space:pre-line;border-left:5px solid var(--primary);padding-left:1rem;line-height:1.55}
.total-pill{display:inline-block;background:var(--secondary);color:#fff;padding:.28rem .85rem;border-radius:9999px;font-weight:700;font-size:.8rem;margin-top:.5rem}
#miniMap{height:240px;border:1px solid var(--border);border-radius:6px;margin-top:.6rem}
.address-status{white-space:pre-line;background:#fffdf7;border:1px dashed var(--border);padding:.6rem .7rem;border-radius:6px;margin-top:.7rem;font-size:.9rem}
.warn{border-left:4px solid var(--primary);background:#fff8e6;padding:.7rem 1rem;border-radius:6px;color:#b45309;font-weight:600;margin-bottom:1rem}
.hidden{display:none!important}
@media(min-width:768px){h1{font-size:2rem}}
</style>
</head>
<body>
<header><h1>SGIP Residential Solar & Storage Equity Calculator</h1></header>

<main class="container">

  <!-- === CALCULATOR CARD (center) === -->
  <section class="card" id="calcCard">
    <h2 class="section">Estimate your incentive</h2>

    <div id="waitlistBanner" class="warn hidden">⚠️ Possible waitlist once IOU funds are subscribed.</div>

    <table class="budget" aria-describedby="budget-note">
      <thead><tr><th>Budget Bucket</th><th>Total (2025)</th></tr></thead>
      <tbody>
        <tr><td>Residential Solar &amp; Storage Equity</td><td>$252 M</td></tr>
        <tr><td>Residential Storage Equity</td><td>$13 M</td></tr>
      </tbody>
    </table>
    <p id="budget-note" class="help">Totals from CPUC fact-sheet; real-time availability may differ.</p>

    <!-- Address + HUD blocks (unchanged UI) -->
    <div class="card" style="margin:1.5rem 0">
      <h3>Quick address check</h3>
      <div class="form-field"><label for="addr">Address</label><input id="addr" placeholder="123 Main St, City, CA"></div>
      <div class="actions"><button class="primary" type="button" id="addrBtn">Check</button><button class="secondary" type="button" id="addrClr">Clear</button></div>
      <div id="addrStatus" class="address-status hidden"></div>
      <div id="miniMap" class="hidden"></div>
    </div>

    <div class="card">
      <h3>Income auto-fill (HUD)</h3>
      <div class="form-field"><label for="zip">ZIP Code</label><input id="zip" inputmode="numeric" pattern="\\d{5}" placeholder="e.g., 90001"></div>
      <div class="form-field"><label for="income">Annual Household Income ($)</label><input id="income" type="number" min="0" step="100"></div>
      <div class="actions"><button type="button" class="primary" id="hudBtn">Fetch AMI %</button></div>
      <div id="hudMsg" class="help"></div>
    </div>

    <!-- Utility selector (auto-detected) -->
    <div class="form-field" style="margin-top:1.4rem">
      <label for="util">Utility territory (auto-detects)</label>
      <select id="util"><option value="">Select / auto-detect</option><option value="PGE">PG&amp;E</option><option value="SCE">SCE</option><option value="SDGE">SDG&amp;E</option><option value="SCG">SoCalGas</option><option value="LADWP">LADWP</option><option value="OTHER">Other</option></select>
      <div class="help" style="margin-top:.4rem">Status: <span id="utilPill" class="pill pending">Pending</span> <span id="utilTxt"></span></div>
    </div>

    <form id="calcForm" novalidate>
      <div class="form-field">
        <label for="cust">Customer class</label>
        <select id="cust" required>
          <option value=""></option><option value="residential-single">Residential Single-Family</option><option value="residential-multi">Residential Multifamily</option>
        </select><div id="custErr" class="error hidden"></div>
      </div>
      <div class="form-field">
        <label for="kwh">Storage capacity (kWh)</label>
        <input id="kwh" type="number" min="0" step="0.1" value="15"><div id="kwhErr" class="error hidden"></div>
      </div>
      <div class="form-field"><label for="kw">Solar PV size (kW)</label><input id="kw" type="number" min="0" step="0.1" value="5"></div>
      <div class="form-field"><label for="ami">Income as % AMI</label><input id="ami" type="number" min="0" max="300" step=".1" placeholder="e.g., 60"></div>
      <div class="actions"><button class="primary" type="submit" id="calcBtn" disabled>Calculate</button><button class="secondary" type="button" id="pdfBtn" disabled>Export PDF</button><button class="secondary" type="reset">Clear</button></div>
    </form>

    <output id="result" class="hidden" aria-live="polite"></output>
  </section>

  <!-- === MAPS === -->
  <section class="maps card">
    <h2 class="section">Reference maps &amp; tools</h2>

    <h3>SB 535 Disadvantaged Communities Map</h3>
    <iframe src="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/" title="DAC map"></iframe>

    <h3>Community Air Protection (CAP UC) Map</h3>
    <iframe src="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2" title="CAP UC map"></iframe>

    <h3>SCE Public-Safety Shutoff Status</h3>
    <p><a href="https://www.sce.com/outages-safety/outage-center/check-outage-status" target="_blank" rel="noopener">Check PSPS status ↗</a></p>
  </section>
</main>

<script>
/* ---------- CONFIG ---------- */
const CONFIG={geocode:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates",
sb535:"https://services1.arcgis.com/PCHfdHz4GlDNAhBb/ArcGIS/rest/services/SB_535_Disadvantaged_Communities_2022/FeatureServer/0/query",
fire:["https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/0/query","https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/1/query"],
psps:"https://services2.arcgis.com/VofPZYDe2pLxSP5G/arcgis/rest/services/Consolidated_PSPS_Map20221231_gdb/FeatureServer/0/query",
paUrl:"",paField:"UTILITY_CODE",
hud:{key:"",year:2024,base:"https://www.huduser.gov/hudapi/public/il/v2/zip"},
open:{IOU:"2025-05-20"},R:{perWh:1.1,perKw:3100},time:15000};
const IOU=["PGE","SCE","SDGE","SCG"];
/* ---------- DOM ---------- */
const $=s=>document.querySelector(s);
const els={addr:$("#addr"),addrBtn:$("#addrBtn"),addrClr:$("#addrClr"),addrStatus:$("#addrStatus"),mini:$("#miniMap"),
zip:$("#zip"),income:$("#income"),hudBtn:$("#hudBtn"),hudMsg:$("#hudMsg"),
util:$("#util"),utilPill:$("#utilPill"),utilTxt:$("#utilTxt"),wait:$("#waitlistBanner"),
cust:$("#cust"),custErr:$("#custErr"),
kwh:$("#kwh"),kwhErr:$("#kwhErr"),kw:$("#kw"),ami:$("#ami"),
calcBtn:$("#calcBtn"),pdfBtn:$("#pdfBtn"),res:$("#result"),form:$("#calcForm")};
/* ---------- HELPERS ---------- */
const money=n=>Number(n).toLocaleString();const pct=n=>n.toFixed(1);
const timeout=(p,label)=>Promise.race([p,new Promise((_,r)=>setTimeout(()=>r(new Error(label+" timeout")),CONFIG.time))]);
const fetchJ=u=>timeout(fetch(u),"fetch").then(r=>{if(!r.ok)throw Error("HTTP "+r.status);return r.json()});
function utilStatus(code){let pill=els.utilPill,txt=els.utilTxt,pending=true,open=false;
const today= new Date().toISOString().slice(0,10);
if(IOU.includes(code)){ if(today>=CONFIG.open.IOU)open=true; } else if(code==="OTHER")open=true;
pill.textContent=open?"OPEN":pending?"PENDING":"CLOSED"; pill.className="pill "+(open?"open":"pending");
txt.textContent=open?"":"Select / detect utility"; els.calcBtn.disabled=!open; els.wait.classList.toggle("hidden",!IOU.includes(code));}
function validate(){let ok=true;if(!els.cust.value){els.custErr.textContent="Select class";els.custErr.classList.remove("hidden");ok=false}else els.custErr.classList.add("hidden");
const k=parseFloat(els.kwh.value);if(!k||k<=0){els.kwhErr.textContent="kWh > 0";els.kwhErr.classList.remove("hidden");ok=false}else els.kwhErr.classList.add("hidden");
return ok}
/* ---------- ARCGIS helpers ---------- */
async function geocode(a){const p=new URLSearchParams({SingleLine:a,outFields:"Match_addr",f:"json"});
const j=await fetchJ(`${CONFIG.geocode}?${p}`);const c=j.candidates?.[0];if(!c)throw Error("no match");return{...c.location}}
async function point(layer,pt){if(!layer)return null;const p=new URLSearchParams({f:"json",geometry:JSON.stringify({x:pt.x,y:pt.y,spatialReference:{wkid:4326}}),geometryType:"esriGeometryPoint",inSR:"4326",spatialRel:"esriSpatialRelIntersects",returnGeometry:"false",outFields:"*"});return(await fetchJ(`${layer}?${p}`)).features?.[0]}
async function inAny(arr,pt){for(const u of arr)try{const f=await point(u,pt);if(f)return f}catch{}return null}
async function detectPA(pt){if(!CONFIG.paUrl)return null;const f=await point(CONFIG.paUrl,pt);return f?.attributes?.[CONFIG.paField]||null}
/* ---------- MAP ---------- */
let map,marker;function showMap(lat,lon){els.mini.classList.remove("hidden");if(!map){map=L.map(els.mini).setView([lat,lon],14);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);marker=L.marker([lat,lon]).addTo(map);}else{map.setView([lat,lon],14);marker.setLatLng([lat,lon]);}}
/* ---------- ADDRESS CHECK ---------- */
els.addrBtn.onclick=async()=>{const raw=els.addr.value.trim();if(!raw){status("Enter address");return}
status("Geocoding…");try{const pt=await geocode(raw);showMap(pt.y,pt.x);
status("Checking layers…");const dac=!!await point(CONFIG.sb535,pt);const fire=!!await inAny(CONFIG.fire,pt);const psps=!!await point(CONFIG.psps,pt);
let util=null;if(CONFIG.paUrl){status("Detecting utility…");util=await detectPA(pt);if(util){els.util.value=util;utilStatus(util);}}
status(`(${pt.y.toFixed(5)}, ${pt.x.toFixed(5)})\nUtility: ${util||"—"}\nDAC: ${dac?"Yes":"No"} • Fire: ${fire?"Yes":"No"} • PSPS: ${psps?"Yes":"No"}`,
[util||"",dac?"DAC":"",fire?"Fire":"",psps?"PSPS":""]);els.calcBtn.disabled=els.utilPill.textContent!=="OPEN";
}catch(e){status("Error: "+e.message)}}
function status(msg,badges=[]){els.addrStatus.innerHTML=`${badges.map(b=>`<span class="badge">${b}</span>`).join(" ")} ${msg}`;els.addrStatus.classList.remove("hidden")}
els.addrClr.onclick=()=>{els.addr.value="";els.addrStatus.classList.add("hidden");els.mini.classList.add("hidden")}
/* ---------- HUD ---------- */
els.hudBtn.onclick=async()=>{const zip=els.zip.value.trim();const inc=parseFloat(els.income.value);if(zip.length!==5||!inc){els.hudMsg.textContent="ZIP & income required";return}
try{els.hudMsg.textContent="HUD lookup…";const j=await fetchJ(`${CONFIG.hud.base}/${zip}?year=${CONFIG.hud.year}`,CONFIG.time);const mfi=j.data?.[0]?.medianFamilyIncome;if(!mfi)throw Error("no MFI");const pct=(inc/mfi*100).toFixed(1);els.ami.value=pct;els.hudMsg.textContent=`AMI ≈ ${pct}%`; }catch(e){els.hudMsg.textContent=e.message}}
/* ---------- UTILITY change ---------- */
els.util.onchange=()=>utilStatus(els.util.value);
/* ---------- CALC ---------- */
els.form.onsubmit=e=>{e.preventDefault();if(!validate())return;const kwh=parseFloat(els.kwh.value),kw=parseFloat(els.kw.value)||0;
const storage=Math.round(kwh*1000*CONFIG.R.perWh),solar=Math.round(kw*CONFIG.R.perKw),total=storage+solar;
els.res.innerHTML=`Estimated incentive\n• Storage $${money(storage)}\n• Solar $${money(solar)}\n\n<span class="total-pill">TOTAL $${money(total)}</span>`;
els.res.classList.remove("hidden");els.pdfBtn.disabled=false;}
els.pdfBtn.onclick=()=>{const w=open("");w.document.write(`<pre style="font-family:system-ui;font-size:14px">${els.res.innerText}</pre>`);w.print();}
</script>
</body>
</html>
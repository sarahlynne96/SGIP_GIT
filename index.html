<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>SGIP Eligibility & Incentive Calculator</title>

  <!-- Leaflet (for the small map preview) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o9N1j7kGStG3v3lR82GkGzm1G3S2MKCkG4ZkT2f0Xpw="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStG3v3lR82GkGzm1G3S2MKCkG4ZkT2f0Xpw="
    crossorigin=""
    defer
  ></script>

  <style>
    :root {
      /* -------- ORANGE LIGHT THEME -------- */
      --color-primary: #ff7a00;          /* main CTA / highlights */
      --color-secondary: #cc5a00;        /* section titles, labels */
      --color-accent: #ff9f1c;           /* links, hovers, chips */
      --focus-ring: 3px solid #ff7a00;   /* accessible orange focus */

      --color-bg: #fdfbf8;
      --color-surface: #ffffff;
      --color-text: #1f1f1f;
      --color-text-muted: #6b6b6b;
      --color-border: #e6e2dc;
      --color-error: #c0392b;

      --fs-base: 1rem;
      --fs-sm: 0.875rem;
      --fs-lg: 1.125rem;
      --fs-xl: clamp(1.25rem, 3vw, 1.75rem);

      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.5rem;
      --space-6: 2rem;

      --radius: 0.5rem;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.08);
      --transition: 160ms ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { min-height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      font-size: var(--fs-base);
      line-height: 1.5;
    }

    a { color: var(--color-accent); text-decoration: none; }
    a:hover, a:focus { text-decoration: underline; }

    h1, h2, h3 { line-height: 1.2; margin: 0 0 var(--space-3); }
    .section-title { font-size: var(--fs-lg); color: var(--color-secondary); margin-bottom: var(--space-3); }

    .skip-link { position: absolute; left: -999px; top: -999px; }
    .skip-link:focus { position: static; background: var(--color-accent); color: #fff; padding: var(--space-2) var(--space-3); }

    .site-header, .site-footer {
      padding: var(--space-4);
      background: var(--color-surface);
      box-shadow: var(--shadow-sm);
    }
    .site-title {
      font-size: var(--fs-xl);
      text-align: center;
      color: var(--color-primary);
      margin: 0;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-5);
      max-width: 1200px;
      padding: var(--space-4);
      margin: 0 auto;
    }
    @media (min-width: 768px) {
      .container {
        grid-template-columns: 60% 40%;
        align-items: start;
      }
    }

    .map-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: var(--space-4);
    }
    .map-card__title {
      padding: var(--space-3) var(--space-4);
      background: var(--color-secondary);
      color: #fff;
      font-size: var(--fs-base);
    }
    .map-card__actions {
      padding: var(--space-2) var(--space-4) 0;
      font-size: var(--fs-sm);
    }
    .map-card iframe {
      width: 100%;
      height: 400px;
      border: 0;
      display: block;
    }

    .calculator {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: var(--space-4);
      position: sticky;
      top: var(--space-4);
    }

    .form-field { margin-bottom: var(--space-4); }
    label {
      display: block;
      font-weight: 600;
      color: var(--color-secondary);
      margin-bottom: var(--space-2);
    }

    input, select, button { font-size: var(--fs-base); line-height: 1.2; }
    input, select {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: transparent;
      color: inherit;
      transition: border-color var(--transition), box-shadow var(--transition);
      min-height: 44px;
    }
    input:focus, select:focus, button:focus { outline: var(--focus-ring); outline-offset: 2px; }

    .help { display: block; color: var(--color-text-muted); margin-top: var(--space-2); font-size: var(--fs-sm); }
    .error { color: var(--color-error); font-size: var(--fs-sm); margin: var(--space-2) 0 0; }

    .form-actions { display: flex; gap: var(--space-3); flex-wrap: wrap; }

    button {
      border: none;
      border-radius: var(--radius);
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      transition: background var(--transition), transform var(--transition);
      min-height: 44px;
    }
    button:active { transform: translateY(1px); }
    .btn-primary { background: var(--color-primary); color: #000; }
    .btn-primary:hover { background: var(--color-accent); color: #000; }
    .btn-secondary { background: transparent; border: 1px solid var(--color-border); color: inherit; }
    .btn-secondary:hover { background: var(--color-border); }

    .result {
      margin-top: var(--space-5);
      padding: var(--space-4);
      background: var(--color-surface);
      border-left: 5px solid var(--color-primary);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      font-size: var(--fs-base);
      line-height: 1.5;
      white-space: pre-line;
    }

    .address-check {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: var(--space-4);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-4);
    }
    .address-status {
      margin-top: var(--space-3);
      padding: var(--space-3);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius);
      font-size: var(--fs-sm);
      background: #fff8f0;
    }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.25rem;
      color: #000;
      background: var(--color-accent);
    }

    #miniMap {
      height: 250px;
      margin-top: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <header class="site-header" role="banner">
    <h1 class="site-title">SGIP Eligibility &amp; Incentive Calculator</h1>
  </header>

  <main id="main" class="container" role="main">
    <section class="maps" aria-labelledby="maps-heading">
      <h2 id="maps-heading" class="section-title">Reference Maps &amp; Tools</h2>

      <article class="map-card" aria-labelledby="sb535-title">
        <h3 id="sb535-title" class="map-card__title">SB&nbsp;535 Disadvantaged Communities Map</h3>
        <p class="map-card__actions">
          <a href="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/"
             target="_blank" rel="noopener">ðŸ”Ž Open full screen (best on mobile)</a>
        </p>
        <iframe
          src="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/"
          title="SB 535 Disadvantaged Communities Map"
          loading="lazy"
        ></iframe>
      </article>

      <article class="map-card" aria-labelledby="capuc-title">
        <h3 id="capuc-title" class="map-card__title">Community Air Protection (CAP UC) Map</h3>
        <p class="map-card__actions">
          <a href="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2"
             target="_blank" rel="noopener">ðŸ”Ž Open full screen (best on mobile)</a>
        </p>
        <iframe
          src="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2"
          title="Community Air Protection (CAP UC) Map"
          loading="lazy"
        ></iframe>
      </article>

      <article class="map-card" aria-labelledby="sce-title">
        <h3 id="sce-title" class="map-card__title">SCE Shutoff (Outage Status) Tool</h3>
        <p class="map-card__actions">
          <a href="https://www.sce.com/outages-safety/outage-center/check-outage-status"
             target="_blank" rel="noopener">ðŸ”— Check Public Safety Shutoff Status</a>
        </p>
      </article>
    </section>

    <aside class="calculator" aria-labelledby="calc-heading">
      <h2 id="calc-heading" class="section-title">Calculator</h2>

      <!-- Address checker -->
      <section class="address-check" aria-labelledby="addr-title">
        <h3 id="addr-title">Quick Address Check (DAC / Fire Tier 2-3 / PSPS)</h3>

        <div class="form-field">
          <label for="addressInput">Address</label>
          <input id="addressInput" type="text" placeholder="123 Main St, City, CA" autocomplete="street-address" />
        </div>

        <div class="form-actions">
          <button type="button" id="checkAddressBtn" class="btn-primary">Check Address Against Maps</button>
          <button type="button" id="clearAddressBtn" class="btn-secondary">Clear</button>
        </div>

        <div id="addressStatus" class="address-status hidden" role="status" aria-live="polite"></div>
        <div id="miniMap" class="hidden" aria-label="Address preview map"></div>

        <small class="help">
          Uses ArcGIS REST queries. Results are advisory onlyâ€”confirm with official tools.
        </small>
      </section>

      <form id="calcForm" novalidate data-testid="calc-form">
        <!-- 1 -->
        <div class="form-field" data-required>
          <label for="customerType">1. Host Customer Class</label>
          <select id="customerType" name="customerType" data-testid="customerType" required aria-describedby="customerType-help">
            <option value="">Select type</option>
            <option value="residential-single">Residential Single-Family</option>
            <option value="residential-multi">Residential Multifamily</option>
            <option value="commercial">Commercial/Business</option>
            <option value="industrial">Industrial/Agricultural</option>
          </select>
          <small id="customerType-help" class="help">
            Must be utility customer of record; rentals need explanation letter.
          </small>
          <p class="error" id="customerType-error" hidden></p>
        </div>

        <!-- 2 -->
        <div class="form-field">
          <label for="inDAC">2. Disadvantaged Community (DAC)?</label>
          <select id="inDAC" name="inDAC" data-testid="inDAC">
            <option value=""></option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <!-- 3 -->
        <div class="form-field">
          <label for="inFire">3. Tier 2/3 Wildfire Threat Zone?</label>
          <select id="inFire" name="inFire" data-testid="inFire">
            <option value=""></option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <!-- 4 -->
        <div class="form-field">
          <label for="inPSPS">4. Located in a PSPS Shutoff Area?</label>
          <select id="inPSPS" name="inPSPS" data-testid="inPSPS" aria-describedby="inPSPS-help">
            <option value=""></option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small id="inPSPS-help" class="help">
            Refer to CPUC PSPS lookup tool separate from this calculator.
          </small>
        </div>

        <!-- 5 -->
        <div class="form-field">
          <label for="equityPathway1">5. Multifamily Equity Pathway</label>
          <select id="equityPathway1" name="equityPathway1" data-testid="equityPathway1">
            <option value=""></option>
            <option value="deed">Deed-restricted low-income housing (â‰¥5 units)</option>
            <option value="80pct">â‰¥80% units â‰¤60% AMI</option>
            <option value="mash">Reserved MASH/SOMAH funds</option>
          </select>
        </div>

        <!-- 6 -->
        <div class="form-field">
          <label for="singleEquity">6. Single-Family Equity Criterion</label>
          <select id="singleEquity" name="singleEquity" data-testid="singleEquity">
            <option value=""></option>
            <option value="income">Income verified per HUD</option>
            <option value="program">Participated in SASH/DAC-SASH/CARE/FERA/ESA</option>
          </select>
        </div>

        <!-- 7 -->
        <div class="form-field">
          <label for="care">7. CARE Program Participation</label>
          <select id="care" name="care" data-testid="care" aria-describedby="care-help">
            <option value=""></option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
            <option value="unsure">Unsure</option>
          </select>
          <small id="care-help" class="help">
            Customers must provide proof of eligibility status in the MASH, SOMAH, SASH, or DAC-SASH, CARE, FERA, or ESA program. CARE, FERA, and ESA documents must reflect income verification has
            been completed as a result of participation in the programs.
          </small>
        </div>

        <!-- 8 -->
        <div class="form-field">
          <label for="govAssistance">8. Receiving any government assistance (e.g., SNAP, Medicaid, SSI, etc.)?</label>
          <select id="govAssistance" name="govAssistance" data-testid="govAssistance">
            <option value=""></option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <!-- 9 -->
        <div class="form-field">
          <label for="squareFootage">9. Home Square Footage</label>
          <input
            type="number"
            id="squareFootage"
            name="squareFootage"
            min="0"
            placeholder="e.g., 2000"
            inputmode="numeric"
            data-testid="squareFootage"
          />
          <small class="help">
            Will estimate PV size if left blank. Uses 0.0035 kW per ftÂ² (â‰ˆ7 kW for 2,000 ftÂ²).
          </small>
        </div>

        <!-- 10 -->
        <div class="form-field" data-required>
          <label for="capacity">10. Storage Capacity (kWh)</label>
          <input
            type="number"
            id="capacity"
            name="capacity"
            min="0"
            step="0.1"
            value="30.6"
            placeholder="Default 30.6 kWh (3 batteries)"
            inputmode="decimal"
            required
            data-testid="capacity"
          />
          <small class="help">
            Defaults to 3 batteries totaling 30.6 kWh.
          </small>
          <p class="error" id="capacity-error" hidden></p>
        </div>

        <!-- 11 -->
        <div class="form-field">
          <label for="solarCapacity">11. Solar PV Capacity (kW)</label>
          <input
            type="number"
            id="solarCapacity"
            name="solarCapacity"
            min="0"
            step="0.1"
            placeholder="Leave blank to auto-estimate from square footage"
            inputmode="decimal"
            data-testid="solarCapacity"
          />
        </div>

        <!-- 12 -->
        <div class="form-field">
          <label for="backup">12. Backup Capability?</label>
          <select id="backup" name="backup" data-testid="backup">
            <option value=""></option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="submit" id="btnCheck" class="btn-primary" data-testid="calculate">
            Calculate Eligibility &amp; Incentive
          </button>
          <button type="button" id="btnReset" class="btn-secondary" data-testid="reset">
            Clear
          </button>
        </div>
      </form>

      <output
        id="result"
        class="result"
        role="status"
        aria-live="polite"
        data-testid="result"
        hidden
      ></output>
    </aside>
  </main>

  <footer class="site-footer" role="contentinfo">
    <p>
      <small>
        Built with accessibility and responsiveness in mind. Press <kbd>Enter</kbd> to calculate, <kbd>Esc</kbd> to clear.
      </small>
    </p>
  </footer>

  <script>
    /************************************************************
     * CONFIG: Production ArcGIS endpoints (kept from previous build)
     ************************************************************/
    const CONFIG = {
      geocodeUrl:
        "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates",

      // SB 535 Disadvantaged Communities 2022 (Census Tracts & Tribal Areas) â€“ layer 0
      sb535Url:
        "https://services1.arcgis.com/PCHfdHz4GlDNAhBb/ArcGIS/rest/services/SB_535_Disadvantaged_Communities_2022/FeatureServer/0/query",

      // CPUC Fire Threat Areas â€“ Tier 3 (0) & Tier 2 (1)
      wildfireTierUrls: [
        "https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/0/query", // Tier 3
        "https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/1/query"  // Tier 2
      ],

      // CPUC Consolidated PSPS polygons (layer 0)
      pspsUrl:
        "https://services2.arcgis.com/VofPZYDe2pLxSP5G/arcgis/rest/services/Consolidated_PSPS_Map20221231_gdb/FeatureServer/0/query",
    };

    const RATES = {
      solarRate: 3100,
      resiliencyEqRate: 1.0,
      equityRate: 0.85,
      sjvResRate: 1.1,
      smallResRate: 0.15,
      largeScaleRate: 0.25
    };

    const KW_PER_SQFT = 0.0035;

    const SELECTORS = {
      form: "#calcForm",
      result: "#result",
      btnReset: "#btnReset",
      addressInput: "#addressInput",
      checkAddressBtn: "#checkAddressBtn",
      clearAddressBtn: "#clearAddressBtn",
      addressStatus: "#addressStatus",
      inDAC: "#inDAC",
      inFire: "#inFire",
      inPSPS: "#inPSPS",
      miniMap: "#miniMap"
    };

    const qs = (sel, root = document) => root.querySelector(sel);
    const money = n => n.toLocaleString(undefined, { maximumFractionDigits: 2 });
    const number = n => n.toLocaleString(undefined, { maximumFractionDigits: 1 });

    /* ---------- caching ---------- */
    const ADDRESS_CACHE_KEY = "sgipAddressCache_v1_orange";
    function loadCache() {
      try {
        return JSON.parse(localStorage.getItem(ADDRESS_CACHE_KEY)) || {};
      } catch {
        return {};
      }
    }
    function saveCache(cache) {
      try {
        localStorage.setItem(ADDRESS_CACHE_KEY, JSON.stringify(cache));
      } catch {}
    }
    const addressCache = loadCache();

    /* ---------- validation ---------- */
    function validate(form) {
      let valid = true;

      const customerType = form.customerType;
      const customerTypeError = qs("#customerType-error");
      if (!customerType.value) {
        customerTypeError.hidden = false;
        customerTypeError.textContent = "Please select a customer type.";
        valid = false;
      } else {
        customerTypeError.hidden = true;
        customerTypeError.textContent = "";
      }

      const capacity = parseFloat(form.capacity.value);
      const capacityError = qs("#capacity-error");
      if (isNaN(capacity) || capacity <= 0) {
        capacityError.hidden = false;
        capacityError.textContent = "Please provide a valid storage capacity (kWh).";
        valid = false;
      } else {
        capacityError.hidden = true;
        capacityError.textContent = "";
      }
      return valid;
    }

    /* ---------- calc ---------- */
    function calculate(data) {
      const {
        cust,
        inFire,
        inPSPS,
        multiPath,
        singlePath,
        careSelected,
        govAssist,
        squareFootage,
        capacityInput,
        solarCapacityInput
      } = data;

      let capacity = parseFloat(capacityInput) || 30.6;
      if (capacity <= 0) capacity = 30.6;

      let solarCap = parseFloat(solarCapacityInput) || 0;
      let autoPvKwUsed = null;

      if (!solarCap && squareFootage > 0) {
        autoPvKwUsed = Math.max(1, squareFootage * KW_PER_SQFT);
        solarCap = parseFloat(autoPvKwUsed.toFixed(1));
      }

      let rate = 0;
      let budget = "";

      if (
        (cust === "residential-multi" && multiPath) ||
        (cust === "residential-single" && singlePath)
      ) {
        budget = "Equity Storage";
        rate = RATES.sjvResRate;
      } else if (inFire || inPSPS) {
        budget = "Equity Resiliency Storage";
        rate = RATES.resiliencyEqRate;
      } else if (cust && cust.startsWith("residential")) {
        budget = "Small Residential Storage";
        rate = RATES.smallResRate;
      } else {
        budget = "Large-Scale Storage";
        rate = RATES.largeScaleRate;
      }

      const storageIncentive = capacity * 1000 * rate;
      const solarIncentive = solarCap * RATES.solarRate;
      const totalIncentive = storageIncentive + solarIncentive;

      let explanation = `You qualify under the **${budget}** category at a rate of $${rate.toFixed(
        2
      )}/Wh, resulting in $${money(storageIncentive)} for ${number(
        capacity
      )}â€¯kWh of storage.\n`;

      if (solarCap > 0) {
        explanation += `Additionally, ${number(
          solarCap
        )}â€¯kW of solar PV earns $${money(
          solarIncentive
        )} at $${RATES.solarRate}/kW.\n`;
      }

      if (autoPvKwUsed !== null) {
        explanation += `Based on ${squareFootage.toLocaleString()}â€¯ftÂ², we estimated a typical PV system size of ~${number(
          solarCap
        )}â€¯kW (using ${KW_PER_SQFT * 1000}â€¯W/ftÂ²).\n`;
      }

      if (careSelected)
        explanation += `As a CARE participant, you save ~20% on your electric bill.\n`;
      if (govAssist)
        explanation += `Because you indicated you're receiving government assistance, you may qualify for CARE automatically.\n`;

      explanation += `\n**Total SGIP incentives: $${money(totalIncentive)}.**`;

      return { explanation };
    }

    /* ---------- ArcGIS helpers ---------- */
    async function geocodeAddress(address) {
      const params = new URLSearchParams({
        SingleLine: address,
        outFields: "Match_addr,Addr_type",
        f: "json",
      });

      const url = `${CONFIG.geocodeUrl}?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Geocoding failed");
      const json = await res.json();

      const candidate = (json.candidates || [])[0];
      if (!candidate) throw new Error("No match found");
      return {
        x: candidate.location.x,
        y: candidate.location.y,
        score: candidate.score,
        matchAddress: candidate.address,
      };
    }

    async function pointInLayer({ x, y }, layerQueryUrl) {
      const params = new URLSearchParams({
        f: "json",
        geometry: JSON.stringify({ x, y, spatialReference: { wkid: 4326 } }),
        geometryType: "esriGeometryPoint",
        inSR: "4326",
        spatialRel: "esriSpatialRelIntersects",
        outFields: "*",
        returnGeometry: "false",
      });

      const res = await fetch(`${layerQueryUrl}?${params.toString()}`);
      if (!res.ok) throw new Error("Layer query failed");
      const json = await res.json();
      return (json.features || []).length > 0 ? json.features[0] : null;
    }

    async function pointInAnyLayer(point, urls) {
      for (const url of urls) {
        const f = await pointInLayer(point, url);
        if (f) return f;
      }
      return null;
    }

    /* ---------- tiny map ---------- */
    let miniMap;
    let miniMarker;
    function updateMiniMap(lat, lon) {
      const el = qs(SELECTORS.miniMap);
      el.classList.remove("hidden");

      if (!miniMap) {
        miniMap = L.map(el).setView([lat, lon], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(miniMap);
        miniMarker = L.marker([lat, lon]).addTo(miniMap);
      } else {
        miniMap.setView([lat, lon], 14);
        if (miniMarker) {
          miniMarker.setLatLng([lat, lon]);
        } else {
          miniMarker = L.marker([lat, lon]).addTo(miniMap);
        }
      }
    }

    function setAddressStatus(message, badges = []) {
      const box = qs(SELECTORS.addressStatus);
      box.innerHTML = `
        ${badges.map(b => `<span class="badge">${b}</span>`).join(" ")}
        ${message}
      `;
      box.classList.remove("hidden");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = qs(SELECTORS.form);
      const resultEl = qs(SELECTORS.result);
      const resetBtn = qs(SELECTORS.btnReset);

      const addressInput = qs(SELECTORS.addressInput);
      const checkBtn = qs(SELECTORS.checkAddressBtn);
      const clearBtn = qs(SELECTORS.clearAddressBtn);
      const statusBox = qs(SELECTORS.addressStatus);

      const inDACSelect = qs(SELECTORS.inDAC);
      const inFireSelect = qs(SELECTORS.inFire);
      const inPSPSSelect = qs(SELECTORS.inPSPS);

      checkBtn.addEventListener("click", async () => {
        const raw = addressInput.value.trim();
        if (!raw) {
          setAddressStatus("Please enter an address first.");
          return;
        }
        const address = raw.toLowerCase();

        if (addressCache[address]) {
          const c = addressCache[address];
          setAddressStatus(
            `[cached] DAC: ${c.dac ? "Yes" : "No"} â€¢ Fire Tier 2/3: ${c.fire ? "Yes" : "No"} â€¢ PSPS: ${c.psps ? "Yes" : "No"}. ` +
            `(${c.lat.toFixed(5)}, ${c.lon.toFixed(5)})`,
            [
              c.dac ? "DAC" : "",
              c.fire ? "Tier 2/3" : "",
              c.psps ? "PSPS" : ""
            ].filter(Boolean)
          );
          inDACSelect.value = c.dac ? "yes" : "no";
          inFireSelect.value = c.fire ? "yes" : "no";
          inPSPSSelect.value = c.psps ? "yes" : "no";
          updateMiniMap(c.lat, c.lon);
          return;
        }

        setAddressStatus("Geocoding and checking layers...");
        try {
          const point = await geocodeAddress(raw);
          const lat = point.y;
          const lon = point.x;

          const [dacFeature, fireFeature, pspsFeature] = await Promise.all([
            CONFIG.sb535Url ? pointInLayer(point, CONFIG.sb535Url) : null,
            CONFIG.wildfireTierUrls?.length
              ? pointInAnyLayer(point, CONFIG.wildfireTierUrls)
              : null,
            CONFIG.pspsUrl ? pointInLayer(point, CONFIG.pspsUrl) : null,
          ]);

          const dac = !!dacFeature;
          const fire = !!fireFeature;
          const psps = !!pspsFeature;

          inDACSelect.value = dac ? "yes" : "no";
          inFireSelect.value = fire ? "yes" : "no";
          inPSPSSelect.value = psps ? "yes" : "no";

          const badges = [];
          if (dac) badges.push("DAC");
          if (fire) badges.push("Tier 2/3");
          if (psps) badges.push("PSPS");

          setAddressStatus(
            `Found coordinates: (${lat.toFixed(5)}, ${lon.toFixed(5)}). ` +
            `DAC: ${dac ? "Yes" : "No"} â€¢ Fire Tier 2/3: ${fire ? "Yes" : "No"} â€¢ PSPS: ${psps ? "Yes" : "No"}.`,
            badges
          );

          updateMiniMap(lat, lon);

          addressCache[address] = { dac, fire, psps, lat, lon, ts: Date.now() };
          saveCache(addressCache);
        } catch (err) {
          console.error(err);
          setAddressStatus("Could not determine eligibility from address. Check console & layer URLs.");
        }
      });

      clearBtn.addEventListener("click", () => {
        addressInput.value = "";
        statusBox.classList.add("hidden");
        statusBox.innerHTML = "";
        qs(SELECTORS.miniMap).classList.add("hidden");
        inDACSelect.value = "";
        inFireSelect.value = "";
        inPSPSSelect.value = "";
      });

      form.addEventListener("submit", e => {
        e.preventDefault();

        if (!validate(form)) {
          resultEl.hidden = true;
          return;
        }

        const payload = {
          cust: form.customerType.value,
          inFire: form.inFire.value === "yes",
          inPSPS: form.inPSPS.value === "yes",
          multiPath: form.equityPathway1.value,
          singlePath: form.singleEquity.value,
          careSelected: form.care.value === "yes",
          govAssist: form.govAssistance.value === "yes",
          squareFootage: parseFloat(form.squareFootage.value) || 0,
          capacityInput: form.capacity.value,
          solarCapacityInput: form.solarCapacity.value
        };

        const out = calculate(payload);

        resultEl.innerHTML = out.explanation
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\n/g, "<br />");
        resultEl.hidden = false;

        resultEl.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      resetBtn.addEventListener("click", () => {
        form.reset();
        resultEl.hidden = true;
        form.capacity.value = "30.6";
      });

      document.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          form.reset();
          resultEl.hidden = true;
          form.capacity.value = "30.6";
        }
      });
    });
  </script>
</body>
</html>

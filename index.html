<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SGIP Eligibility & Incentive Calculator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    :root {
      --primary: #fdb813;
      --navy: #003c71;
      --accent: #005eb8;
      --border: #e2e8f0;
      --bg-card: #fff;
      --shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.18);
      --radius: 8px;
      --font-sm: 0.875rem;
      --font-base: 1rem;
      --font-lg: 1.25rem;
      --font-xl: 1.75rem;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f9fafb;
      color: #111;
      font-size: var(--font-base);
    }

    header {
      background: var(--primary);
      color: #000;
      padding: 1rem;
      font-size: var(--font-xl);
      text-align: center;
      font-weight: bold;
    }

    main {
      max-width: 960px;
      margin: auto;
      padding: 1rem;
    }

    section.card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    h2 {
      color: var(--navy);
      font-size: var(--font-lg);
    }

    label {
      display: block;
      margin: 0.75rem 0 0.25rem;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      font-size: var(--font-base);
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    input:focus, select:focus {
      outline: 2px solid var(--accent);
    }

    .button-group {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    button {
      min-height: 44px;
      padding: 0 1rem;
      font-size: var(--font-base);
      border-radius: 4px;
      border: 2px solid transparent;
      cursor: pointer;
    }

    button.primary {
      background: var(--primary);
      color: #000;
      border-color: var(--primary);
    }

    button.secondary {
      background: #fff;
      border-color: var(--primary);
      color: var(--primary);
    }

    button:focus {
      outline: 2px solid var(--accent);
    }

    .pill {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: var(--navy);
      color: #fff;
      border-radius: 999px;
      font-size: var(--font-sm);
      margin: 0.25rem 0;
    }

    .pill.pending {
      background: #ccc;
      color: #000;
    }

    .pill.eligible {
      background: #28a745;
    }

    .pill.ineligible {
      background: #dc3545;
    }

    .error {
      color: red;
      font-size: var(--font-sm);
    }

    #map {
      height: 300px;
      margin-top: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    @media (min-width: 768px) {
      .button-group {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>SGIP Eligibility & Incentive Calculator</header>
  <main>
    <section class="card" id="form-section">
      <h2>Eligibility & Incentive Form</h2>
      <form id="calc-form">
        <label for="address">Address</label>
        <input id="address" type="text" placeholder="123 Main St, City, CA" required />

        <label for="zip">ZIP Code</label>
        <input id="zip" type="text" maxlength="5" required />

        <label for="income">Household Income ($)</label>
        <input id="income" type="number" required />

        <label for="kwh">Battery Size (kWh)</label>
        <input id="kwh" type="number" step="0.1" required />

        <label for="kw">Solar Size (kW)</label>
        <input id="kw" type="number" step="0.1" />

        <label for="utility">Utility</label>
        <select id="utility" required>
          <option value="">Select</option>
          <option value="PGE">PG&E</option>
          <option value="SCE">SCE</option>
          <option value="SCG">SCG</option>
          <option value="CSE">CSE (SDG&E)</option>
        </select>

        <div class="button-group">
          <button type="submit" class="primary">Check Eligibility</button>
        </div>
      </form>
    </section>

    <section class="card" id="results-section">
      <h2>Results</h2>
      <div id="results-summary">
        <div id="storage-result">Storage Incentive: —</div>
        <div id="solar-result">Solar Incentive: —</div>
        <div class="pill" id="total-pill">Total: —</div>
        <div class="pill" id="program-pill">Program: —</div>
        <div class="pill" id="status-pill">Status: —</div>
      </div>
      <div id="eligibility-details"></div>
    </section>

    <section class="card" id="budget-section">
      <h2>Live SGIP Budget Summary</h2>
      <div>RSSE – Ratepayer: <span id="ratepayer-budget">—</span></div>
      <div>RSSE – AB 209: <span id="ab209-budget">—</span></div>
      <div>Small-Residential Storage: <span id="smallres-budget">—</span></div>
    </section>

    <section class="card">
      <h2>Map & Service Area Preview</h2>
      <div id="map"></div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const form = document.getElementById('calc-form');
    const results = document.getElementById('results-summary');
    const programPill = document.getElementById('program-pill');
    const statusPill = document.getElementById('status-pill');
    const totalPill = document.getElementById('total-pill');
    const storageResult = document.getElementById('storage-result');
    const solarResult = document.getElementById('solar-result');
    const eligibilityDetails = document.getElementById('eligibility-details');

    // Live SGIP Incentive Rates as of 7/25/2025
    const incentiveRates = {
      equityResiliency: 1.00,
      residentialEquity: 1.10,
      smallRes: 0.15,
      largeScale: 0.25,
      generation: 2.00,
      solarAdder: 3.10
    };

    function determineProgram({ income, zip, kwh, kw, utility, dac, fire, psps }) {
      let reason = [];

      const qualifiesDAC = dac;
      const qualifiesPSPS = psps;
      const qualifiesFire = fire;
      const isLowIncome = income && income < 80000; // Simplified AMI check

      if (qualifiesPSPS || qualifiesFire) reason.push('Fire/PSPS area');
      if (qualifiesDAC) reason.push('Disadvantaged Community');
      if (isLowIncome) reason.push('Low Income');

      if ((qualifiesFire || qualifiesPSPS) && isLowIncome) {
        return { program: 'Equity Resiliency', rate: incentiveRates.equityResiliency, reason: reason.join(', ') };
      } else if (isLowIncome && qualifiesDAC) {
        return { program: 'Residential Storage Equity', rate: incentiveRates.residentialEquity, reason: reason.join(', ') };
      } else if (utility && ['PGE', 'SCE', 'SCG', 'CSE'].includes(utility)) {
        if (kwh <= 30) {
          return { program: 'Small Residential Storage', rate: incentiveRates.smallRes, reason: 'Standard residential customer' };
        } else {
          return { program: 'Large-Scale Storage', rate: incentiveRates.largeScale, reason: 'High-capacity system' };
        }
      } else {
        return { program: 'General Market (Ineligible)', rate: 0, reason: 'Outside IOU territory or missing criteria' };
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const address = document.getElementById('address').value;
      const zip = document.getElementById('zip').value;
      const income = parseFloat(document.getElementById('income').value);
      const kwh = parseFloat(document.getElementById('kwh').value);
      const kw = parseFloat(document.getElementById('kw').value || '0');
      const utility = document.getElementById('utility').value;

      // Placeholder eligibility logic (simulate ArcGIS results)
      const simulatedLayers = {
        dac: Math.random() > 0.5,
        fire: Math.random() > 0.5,
        psps: Math.random() > 0.5
      };

      const program = determineProgram({
        income,
        zip,
        kwh,
        kw,
        utility,
        ...simulatedLayers
      });

      const storageIncentive = kwh * 1000 * program.rate;
      const solarIncentive = kw * incentiveRates.solarAdder * 1000;
      const total = storageIncentive + solarIncentive;

      storageResult.textContent = `Storage Incentive: $${storageIncentive.toLocaleString()}`;
      solarResult.textContent = `Solar Incentive: $${solarIncentive.toLocaleString()}`;
      totalPill.textContent = `Total: $${total.toLocaleString()}`;

      programPill.textContent = `Program: ${program.program}`;
      statusPill.textContent = program.rate > 0 ? 'Status: Eligible' : 'Status: Ineligible';
      statusPill.className = `pill ${program.rate > 0 ? 'eligible' : 'ineligible'}`;

      eligibilityDetails.innerHTML = `<p><strong>Reason:</strong> ${program.reason}</p>`;
    });
  </script>
</body>
</html>




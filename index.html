<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SGIP Rebate & Eligibility Calculator</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f8fb;color:#222;margin:0;padding:0}
    .container{max-width:700px;margin:auto;padding:1rem;background:#fff;box-shadow:0 0 8px rgba(0,0,0,0.1)}
    h1,h2{color:#005daa}
    .form-group{margin-bottom:1.2rem}
    label{display:block;font-weight:600;margin-bottom:.3rem}
    input,select,button{width:100%;padding:.6rem;font-size:1rem;box-sizing:border-box}
    button{background:#005daa;color:#fff;border:none;cursor:pointer;margin-top:1rem}
    button:hover{background:#004a8d}
    .hidden{display:none}
    #map{height:300px;width:100%;margin-bottom:1.5rem;border:1px solid #ccc}
    @media(max-width:600px){.container{padding:.8rem}}
  </style>
</head>
<body>
<main class="container">
  <h1>California SGIP Rebate & Eligibility</h1>
  <div id="map" aria-label="Interactive map showing DAC and Fire Threat overlays"></div>

  <form id="sgipForm" aria-labelledby="sgipForm">
    <div class="form-group">
      <label for="address">Project Address</label>
      <input type="text" id="address" placeholder="City & ZIP in CA" aria-required="true"/>
    </div>
    <!-- other inputs... -->
    <div class="form-group">
      <label for="incomeLevel">Household Income Level</label>
      <select id="incomeLevel">
        <option value="">Selectâ€¦</option>
        <option value="low">Low Income</option>
        <option value="moderate">Moderate Income</option>
        <option value="high">High Income</option>
      </select>
    </div>
    <button type="submit">Calculate</button>
  </form>

  <section id="results" class="hidden" aria-live="polite">
    <h2>Results</h2>
    <p id="eligibility"></p>
    <p id="incentiveLevel"></p>
    <p id="estimatedRebate"></p>
  </section>
</main>

<script src="https://js.arcgis.com/4.25/"></script>
<script>
(async()=>{
  const form=document.getElementById('sgipForm');
  const mapContainer=document.getElementById('map');

  const map = new arcgisJsApi.Map({basemap:'topo-vector'});
  const view = new arcgisJsApi.MapView({container:'map',map,zoom:6,center:[-119,37]});

  const dacLayer=new arcgisJsApi.FeatureLayer({
    url:"https://services1.arcgis.com/PCHfdHz4GlDNAhBb/arcgis/rest/services/SB_535_Disadvantaged_Communities_2022/FeatureServer/0",
    outFields:["*"], popupEnabled:false
  });
  const fireLayer=new arcgisJsApi.KMLLayer({
    url:"https://gis.sanramon.ca.gov/server/rest/services/Engineering/CPUC_Fire_Threat/MapServer/generateKml?layers=0&layerOptions=nonComposite",
    title:"Fire Threat Zones"
  });
  map.addMany([dacLayer, fireLayer]);

  form.addEventListener('submit', async e=>{
    e.preventDefault();
    const addr=document.getElementById('address').value;
    const geo = await arcgisJsApi.identity; // placeholder for geocode
    const geocode = await arcgisJsApi.esriRequest({
      url:"https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates",
      params:{SingleLine:addr,f: 'json', outFields:'*',token:'YOUR_TOKEN'}
    });
    if(!geocode.data.candidates.length) {
      alert('Address not found.');
      return;
    }
    const pt=geocode.data.candidates[0].location;
    view.goTo({center:pt, zoom:12});

    const dacQuery = await dacLayer.queryFeatures({geometry:pt, spatialRelationship:"intersects", outFields:["*"]});
    const inDAC = dacQuery.features.length>0;
    const fireQuery = await fireLayer.queryFeatures({geometry:pt, outFields:["HFTD"]});
    const inFire = fireQuery.features.some(f=>["Tier 2","Tier 3"].includes(f.attributes.HFTD));

    const income=document.getElementById('incomeLevel').value;
    let path="General Market", rate=0.15;
    if(income==="low"){ path="Equity"; rate=1.10; }
    if(inDAC||inFire){ path="Equity Resiliency"; rate=1.00; }

    const size = parseFloat(document.getElementById('systemSize').value)||0;
    const solar = document.getElementById('techType').value==="solar_battery" ? parseFloat(document.getElementById('solarSize').value)||0 : 0;
    const solarRate = solar>0 && path!=="General Market" ? 3.10 : 0;
    const rebate = size*1000*rate + solar*1000*solarRate;

    document.getElementById('eligibility').textContent=`Pathway: ${path}`;
    document.getElementById('incentiveLevel').textContent=`Rates: $${rate.toFixed(2)}/Wh storage${solarRate?` & $${solarRate.toFixed(2)}/kW solar`:''}`;
    document.getElementById('estimatedRebate').textContent=`Estimated Rebate: $${rebate.toLocaleString()}`;
    document.getElementById('results').classList.remove('hidden');
  });
})();
</script>
</body>
</html>
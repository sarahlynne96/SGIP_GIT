<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const form = document.getElementById('calc-form');
    const results = document.getElementById('results-summary');
    const programPill = document.getElementById('program-pill');
    const statusPill = document.getElementById('status-pill');
    const totalPill = document.getElementById('total-pill');
    const storageResult = document.getElementById('storage-result');
    const solarResult = document.getElementById('solar-result');
    const eligibilityDetails = document.getElementById('eligibility-details');

    // Live SGIP Incentive Rates as of 7/25/2025
    const incentiveRates = {
      equityResiliency: 1.00,
      residentialEquity: 1.10,
      smallRes: 0.15,
      largeScale: 0.25,
      generation: 2.00,
      solarAdder: 3.10
    };

    function determineProgram({ income, zip, kwh, kw, utility, dac, fire, psps }) {
      let reason = [];

      const qualifiesDAC = dac;
      const qualifiesPSPS = psps;
      const qualifiesFire = fire;
      const isLowIncome = income && income < 80000; // Simplified AMI check

      if (qualifiesPSPS || qualifiesFire) reason.push('Fire/PSPS area');
      if (qualifiesDAC) reason.push('Disadvantaged Community');
      if (isLowIncome) reason.push('Low Income');

      if ((qualifiesFire || qualifiesPSPS) && isLowIncome) {
        return { program: 'Equity Resiliency', rate: incentiveRates.equityResiliency, reason: reason.join(', ') };
      } else if (isLowIncome && qualifiesDAC) {
        return { program: 'Residential Storage Equity', rate: incentiveRates.residentialEquity, reason: reason.join(', ') };
      } else if (utility && ['PGE', 'SCE', 'SCG', 'CSE'].includes(utility)) {
        if (kwh <= 30) {
          return { program: 'Small Residential Storage', rate: incentiveRates.smallRes, reason: 'Standard residential customer' };
        } else {
          return { program: 'Large-Scale Storage', rate: incentiveRates.largeScale, reason: 'High-capacity system' };
        }
      } else {
        return { program: 'General Market (Ineligible)', rate: 0, reason: 'Outside IOU territory or missing criteria' };
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const address = document.getElementById('address').value;
      const zip = document.getElementById('zip').value;
      const income = parseFloat(document.getElementById('income').value);
      const kwh = parseFloat(document.getElementById('kwh').value);
      const kw = parseFloat(document.getElementById('kw').value || '0');
      const utility = document.getElementById('utility').value;

      // Placeholder eligibility logic (simulate ArcGIS results)
      const simulatedLayers = {
        dac: Math.random() > 0.5,
        fire: Math.random() > 0.5,
        psps: Math.random() > 0.5
      };

      const program = determineProgram({
        income,
        zip,
        kwh,
        kw,
        utility,
        ...simulatedLayers
      });

      const storageIncentive = kwh * 1000 * program.rate;
      const solarIncentive = kw * incentiveRates.solarAdder * 1000;
      const total = storageIncentive + solarIncentive;

      storageResult.textContent = `Storage Incentive: $${storageIncentive.toLocaleString()}`;
      solarResult.textContent = `Solar Incentive: $${solarIncentive.toLocaleString()}`;
      totalPill.textContent = `Total: $${total.toLocaleString()}`;

      programPill.textContent = `Program: ${program.program}`;
      statusPill.textContent = program.rate > 0 ? 'Status: Eligible' : 'Status: Ineligible';
      statusPill.className = `pill ${program.rate > 0 ? 'eligible' : 'ineligible'}`;

      eligibilityDetails.innerHTML = `<p><strong>Reason:</strong> ${program.reason}</p>`;
    });
  </script>
</body>
</html>


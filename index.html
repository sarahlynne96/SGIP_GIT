<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SGIP Residential Solar & Storage Equity Calculator</title>
<meta name="color-scheme" content="light" />

<!-- Leaflet (mini map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<style>
  :root{
    --primary:#ff8c00;
    --primary-dark:#ff7a00;
    --secondary:#0f172a; /* dark navy */
    --accent:#7c3aed;    /* purple accent */
    --bg:#f5f6fa;
    --surface:rgba(255,255,255,0.7);
    --surface-solid:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --border:rgba(255,255,255,0.3);
    --error:#e11d48;
    --warn:#b65e00;

    --radius:14px;
    --shadow:0 12px 24px -12px rgba(0,0,0,.2);
    --backdrop:blur(14px) saturate(150%);

    --fs-sm:.875rem;
    --fs-base:1rem;
    --fs-lg:1.125rem;
    --fs-xl:1.5rem;
    --fs-2xl:2rem;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:linear-gradient(135deg,#ffb347 0%,#ffcc33 35%,#ffe59e 100%);
    min-height:100vh;
  }
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  header{
    padding:2rem 1rem 4rem;
    background:linear-gradient(135deg,#ff7a00 0%,#ffb347 60%,#ffcc33 100%);
    color:#000;
    box-shadow:var(--shadow);
    position:relative;
    overflow:hidden;
  }
  header::after{
    content:"";
    position:absolute;inset:0;
    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="400" viewBox="0 0 1600 400"><path fill="%23ffffff22" d="M0 300 C 300 200 600 350 900 250 C 1200 150 1400 280 1600 200 L 1600 400 L 0 400 Z"/></svg>') center/cover no-repeat;
    opacity:.6;
    pointer-events:none;
  }
  h1{
    margin:0 auto;
    max-width:1100px;
    font-size:var(--fs-2xl);
    font-weight:800;
    line-height:1.1;
    text-shadow:0 1px 0 rgba(255,255,255,.2);
  }

  .container{
    max-width:1300px;margin:-3rem auto 4rem;
    padding:0 1rem;
    display:grid;
    grid-template-columns:1fr;
    gap:1.5rem;
  }
  @media(min-width:1024px){
    .container{
      grid-template-columns:1fr 420px;
      grid-template-areas:
        "main calc"
        "maps maps";
      gap:2rem;
    }
    .main{grid-area:main;}
    .calc-wrap{grid-area:calc;}
    .maps{grid-area:maps;}
  }

  .card{
    background:var(--surface);
    -webkit-backdrop-filter:var(--backdrop);
    backdrop-filter:var(--backdrop);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:1.25rem 1.25rem 1.5rem;
  }
  .solid{background:var(--surface-solid)}

  h2.section{
    margin:.25rem 0 1rem;
    font-size:var(--fs-xl);
    color:var(--secondary);
    letter-spacing:-.01em;
  }
  h3{margin:1rem 0 .75rem;font-size:var(--fs-lg);color:var(--secondary);}

  .form-field{margin-bottom:1rem;}
  label{display:block;margin:0 0 .35rem;font-weight:600;color:var(--secondary);}
  input,select,button{
    font-size:var(--fs-base);
    border-radius:10px;
    border:1px solid #e5e7eb;
    padding:.75rem .9rem;
    width:100%;
    outline:none;
    background:#fff;
  }
  input:focus,select:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 3px rgba(124,58,237,.12);
  }
  .help{color:var(--muted);font-size:var(--fs-sm);margin-top:.35rem;}
  .error{color:var(--error);font-size:var(--fs-sm);margin-top:.35rem;}

  .actions{
    display:flex;gap:.5rem;flex-wrap:wrap;margin-top:1rem;
  }
  .btn{
    cursor:pointer;
    border:none;
    padding:.8rem 1rem;
    border-radius:10px;
    transition:transform .12s,box-shadow .12s,filter .12s;
    min-height:44px;
  }
  .btn:active{transform:translateY(1px) scale(.997);}
  .btn-primary{
    background:var(--primary);
    color:#000;
    box-shadow:0 4px 12px -4px rgba(0,0,0,.2);
  }
  .btn-primary:hover{filter:brightness(1.05);}
  .btn-outline{
    background:transparent;
    border:1px solid #e5e7eb;
  }
  .badge{
    display:inline-block;
    background:#fff;
    color:#000;
    border-radius:9999px;
    padding:.15rem .5rem;
    font-size:.75rem;
    font-weight:600;
    margin-right:.25rem;
    border:1px solid rgba(0,0,0,.05);
  }

  .status{
    display:inline-flex;align-items:center;gap:.4rem;
    font-size:.875rem;margin:.35rem 0 0;
  }
  .pill{
    display:inline-block;padding:.12rem .5rem;border-radius:9999px;color:#fff;font-size:.75rem;font-weight:700;
  }
  .pill-open{background:#16a34a;}
  .pill-pending{background:#f59e0b;color:#000;}
  .pill-closed{background:#dc2626;}

  .warn{
    border-left:4px solid var(--primary);
    background:#fff5e6;
    color:var(--warn);
    padding:.75rem 1rem;
    border-radius:10px;
    margin-bottom:1rem;
    font-weight:600;
  }

  .budget-table{
    width:100%;border-collapse:collapse;margin:1rem 0;border-radius:10px;overflow:hidden;
    box-shadow:var(--shadow);
  }
  .budget-table thead{background:var(--secondary);color:#fff;}
  .budget-table th,.budget-table td{padding:.6rem .75rem;border:1px solid rgba(0,0,0,.04);}
  .budget-table tbody tr:nth-child(odd){background:rgba(255,255,255,.5);}

  #result{
    margin-top:1.25rem;
    line-height:1.6;
    white-space:pre-line;
  }
  #result strong{color:var(--secondary);}
  .total-chip{
    display:inline-block;background:var(--accent);
    color:#fff;border-radius:9999px;padding:.35rem .8rem;
    font-weight:700;margin:.2rem 0 0;
  }

  #miniMap{
    height:240px;margin-top:.65rem;border-radius:10px;border:1px solid rgba(0,0,0,.08);
  }
  .address-status{
    white-space:pre-line;
    background:#fffdf7;border:1px dashed rgba(0,0,0,.12);border-radius:10px;padding:.6rem .75rem;margin-top:.75rem;
    font-size:.9rem;
  }

  .hidden{display:none !important;}
</style>
</head>
<body>
<header>
  <h1>SGIP Residential Solar &amp; Storage Equity ‚Äì Incentive &amp; Eligibility Helper</h1>
</header>

<main class="container">
  <section class="main"></section>

  <!-- CALCULATOR (RIGHT) -->
  <aside class="calc-wrap">
    <div class="card solid" id="calcCard">
      <h2 class="section">Calculator</h2>

      <div id="waitlistBanner" class="warn hidden">
        ‚ö†Ô∏è Possible waitlist due to high demand in IOU territories.
      </div>

      <table class="budget-table" aria-describedby="budget-note">
        <thead><tr><th>Bucket</th><th>Total Budget</th></tr></thead>
        <tbody>
          <tr><td>Storage Incentives</td><td>$280,000,000</td></tr>
          <tr><td>Solar Incentives</td><td>$18,000,000</td></tr>
        </tbody>
      </table>
      <p id="budget-note" class="help">*Static totals. Programs may waitlist as funds are subscribed.</p>

      <!-- Utility (auto-detected) -->
      <div class="form-field">
        <label for="utility">Utility Territory (auto-detects after address check)</label>
        <select id="utility">
          <option value="">Select / auto-detect</option>
          <option value="PGE">PG&amp;E</option>
          <option value="SCE">SCE</option>
          <option value="SDGE">SDG&amp;E</option>
          <option value="SCG">SoCalGas</option>
          <option value="LADWP">LADWP</option>
          <option value="OTHER">Other</option>
        </select>
        <div class="status">
          Status:
          <span id="utilityStatusPill" class="pill pill-pending">Pending</span>
          <span id="utilityStatusText"></span>
        </div>
      </div>

      <!-- Address checker -->
      <section class="card" style="margin-top:1rem">
        <h3>Quick Address Check (DAC / Fire Tier 2-3 / PSPS / Utility)</h3>
        <div class="form-field">
          <label for="addressInput">Address</label>
          <input id="addressInput" placeholder="123 Main St, City, CA" autocomplete="street-address" />
        </div>
        <div class="actions">
          <button type="button" class="btn btn-primary" id="checkAddressBtn">Check Address</button>
          <button type="button" class="btn btn-outline" id="clearAddressBtn">Clear</button>
        </div>
        <div id="addressStatus" class="address-status hidden" role="status" aria-live="polite"></div>
        <div id="miniMap" class="hidden"></div>
        <p class="help">Uses ArcGIS REST. If you see errors, verify the URLs & PA layer config.</p>
      </section>

      <!-- HUD AMI auto-fill -->
      <section class="card" style="margin-top:1rem">
        <h3>Income Auto‚ÄëFill (HUD)</h3>
        <div class="form-field">
          <label for="hudZip">ZIP Code</label>
          <input id="hudZip" type="text" inputmode="numeric" placeholder="e.g., 90001" />
        </div>
        <div class="form-field">
          <label for="hudHousehold">Household Size</label>
          <input id="hudHousehold" type="number" min="1" value="4" />
        </div>
        <div class="form-field">
          <label for="hudIncome">Annual Household Income ($)</label>
          <input id="hudIncome" type="number" min="0" step="100" placeholder="e.g., 55000" />
        </div>
        <div class="actions">
          <button type="button" class="btn btn-primary" id="hudFetchBtn">Fetch & auto‚Äëfill AMI%</button>
        </div>
        <div id="hudStatus" class="help"></div>
      </section>

      <form id="calcForm" novalidate>
        <div class="form-field">
          <label for="customerType">1. Host Customer Class</label>
          <select id="customerType" required>
            <option value="">Select</option>
            <option value="residential-single">Residential Single-Family</option>
            <option value="residential-multi">Residential Multifamily</option>
            <option value="commercial">Commercial/Business</option>
            <option value="industrial">Industrial/Agricultural</option>
          </select>
          <div id="customerType-error" class="error hidden"></div>
        </div>

        <div class="form-field">
          <label for="inDAC">2. Disadvantaged Community (DAC)?</label>
          <select id="inDAC">
            <option value=""></option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>

        <div class="form-field">
          <label for="inFire">3. Tier 2/3 Wildfire Threat Zone?</label>
          <select id="inFire">
            <option value=""></option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>

        <div class="form-field">
          <label for="inPSPS">4. Located in a PSPS Shutoff Area?</label>
          <select id="inPSPS">
            <option value=""></option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>

        <div class="form-field">
          <label for="amiPercent">5. Household income as % of AMI (auto‚Äëfilled or manual)</label>
          <input id="amiPercent" type="number" min="0" max="300" step="0.1" placeholder="e.g., 60" />
          <div class="help">If ‚â§ 80%, generally low‚Äëincome for SGIP Equity.</div>
        </div>

        <div class="form-field">
          <label for="careProgram">6. Participates in CARE / FERA / ESA?</label>
          <select id="careProgram">
            <option value=""></option><option value="yes">Yes</option><option value="no">No</option><option value="unsure">Unsure</option>
          </select>
        </div>

        <div class="form-field">
          <label for="squareFootage">7. Home Square Footage (optional)</label>
          <input id="squareFootage" type="number" min="0" placeholder="e.g., 2000" />
          <div class="help">If PV size blank, we estimate at 0.0035 kW/ft¬≤.</div>
        </div>

        <div class="form-field">
          <label for="capacity">8. Storage Capacity (kWh)</label>
          <input id="capacity" type="number" min="0" step="0.1" value="15" />
          <div id="capacity-error" class="error hidden"></div>
        </div>

        <div class="form-field">
          <label for="solarCapacity">9. Solar PV Capacity (kW)</label>
          <input id="solarCapacity" type="number" min="0" step="0.1" value="5" />
        </div>

        <div class="form-field">
          <label for="backup">10. Backup Capability?</label>
          <select id="backup">
            <option value=""></option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary" id="btnCheck" disabled>Calculate</button>
          <button type="button" class="btn btn-outline" id="btnExport" disabled>Export PDF</button>
          <button type="button" class="btn btn-outline" id="btnReset">Clear</button>
        </div>
      </form>

      <div id="result" class="card hidden"></div>
    </div>
  </aside>

  <!-- MAPS (BOTTOM) -->
  <section class="maps card solid">
    <h2 class="section">Reference Maps &amp; Tools</h2>

    <article class="card">
      <h3>SB 535 Disadvantaged Communities Map</h3>
      <p><a href="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/" target="_blank" rel="noopener">üîé Open full screen</a></p>
      <iframe
        src="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/"
        title="SB 535 DAC Map" loading="lazy" style="width:100%;height:400px;border:0"></iframe>
    </article>

    <article class="card">
      <h3>Community Air Protection (CAP UC) Map</h3>
      <p><a href="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2" target="_blank" rel="noopener">üîé Open full screen</a></p>
      <iframe
        src="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2"
        title="CAP UC Map" loading="lazy" style="width:100%;height:400px;border:0"></iframe>
    </article>

    <article class="card">
      <h3>SCE Shutoff (Outage Status) Tool</h3>
      <p><a href="https://www.sce.com/outages-safety/outage-center/check-outage-status" target="_blank" rel="noopener">üîó Check Public Safety Shutoff Status</a></p>
    </article>
  </section>
</main>

<footer style="padding:2rem 1rem;text-align:center;color:#000;font-size:.9rem;">
  This tool is advisory only. Confirm eligibility, rates, and program status with your SGIP Program Administrator.
</footer>

<script>
/* =======================
   CONFIG
   ======================= */
const CONFIG = {
  geocodeUrl: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates",

  sb535Url: "https://services1.arcgis.com/PCHfdHz4GlDNAhBb/ArcGIS/rest/services/SB_535_Disadvantaged_Communities_2022/FeatureServer/0/query",
  wildfireTierUrls: [
    "https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/0/query",
    "https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/1/query"
  ],
  pspsUrl: "https://services2.arcgis.com/VofPZYDe2pLxSP5G/arcgis/rest/services/Consolidated_PSPS_Map20221231_gdb/FeatureServer/0/query",

  // Set this to your polygon layer & field (or leave empty to skip auto-detect)
  paTerritoriesUrl: "", // e.g. "https://.../FeatureServer/0/query"
  paField: "UTILITY_CODE",

  openDates: {
    IOUs: "2025-05-20",
    LADWP: null
  },

  hud: {
    apiKey: "", // paste HUD key
    year: 2024,
    baseZipUrl: "https://www.huduser.gov/hudapi/public/il/v2/zip"
  },

  timeouts: {
    fetch: 15000
  }
};

const RATES = { storagePerWh: 1.10, solarPerkW: 3100 };
const KW_PER_SQFT = 0.0035;
const IOU_CODES = ["PGE","SCE","SDGE","SCG"];

/* =======================
   DOM SHORTCUTS
   ======================= */
const qs = (s, r=document) => r.querySelector(s);
const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));

const els = {
  form: qs("#calcForm"),
  result: qs("#result"),
  btnCheck: qs("#btnCheck"),
  btnReset: qs("#btnReset"),
  btnExport: qs("#btnExport"),
  utility: qs("#utility"),
  utilityPill: qs("#utilityStatusPill"),
  utilityText: qs("#utilityStatusText"),
  waitlistBanner: qs("#waitlistBanner"),

  addressInput: qs("#addressInput"),
  checkAddressBtn: qs("#checkAddressBtn"),
  clearAddressBtn: qs("#clearAddressBtn"),
  addressStatus: qs("#addressStatus"),
  miniMap: qs("#miniMap"),
  inDAC: qs("#inDAC"),
  inFire: qs("#inFire"),
  inPSPS: qs("#inPSPS"),

  amiPercent: qs("#amiPercent"),
  careProgram: qs("#careProgram"),
  squareFootage: qs("#squareFootage"),
  capacity: qs("#capacity"),
  solarCapacity: qs("#solarCapacity"),

  customerType: qs("#customerType"),
  customerTypeErr: qs("#customerType-error"),
  capacityErr: qs("#capacity-error"),

  hudZip: qs("#hudZip"),
  hudHousehold: qs("#hudHousehold"),
  hudIncome: qs("#hudIncome"),
  hudFetchBtn: qs("#hudFetchBtn"),
  hudStatus: qs("#hudStatus")
};

const ADDRESS_CACHE_KEY = "sgip_addr_v5";
let addressCache = {};
try{ addressCache = JSON.parse(localStorage.getItem(ADDRESS_CACHE_KEY)) || {}; }catch{}

/* =======================
   UTIL / FORMAT
   ======================= */
const money0 = n => n.toLocaleString(undefined,{maximumFractionDigits:0});
const money2 = n => n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const num1   = n => n.toLocaleString(undefined,{maximumFractionDigits:1});

function todayISO(){ return new Date().toISOString().slice(0,10); }
function isAfterOrEqual(a,b){ return new Date(a) >= new Date(b); }

function withTimeout(promise, ms, label){
  const t = new Promise((_,rej)=>setTimeout(()=>rej(new Error(label+" timeout")),ms));
  return Promise.race([promise,t]);
}

/* =======================
   UTILITY STATUS
   ======================= */
function setUtilityStatus(code){
  const pill = els.utilityPill;
  const txt = els.utilityText;

  pill.className = "pill";
  let open=false,pending=false;
  const td = todayISO();

  if(IOU_CODES.includes(code)){
    if(isAfterOrEqual(td,CONFIG.openDates.IOUs)) open=true; else pending=true;
  }else if(code==="LADWP"){
    pending = true;
  }else if(code==="OTHER"){
    open = true;
  }else{
    pending=true;
  }

  if(open){
    pill.textContent = "OPEN";
    pill.classList.add("pill-open");
    txt.textContent = IOU_CODES.includes(code) ? "May 20, 2025 (accepting)" : "Check PA for dates.";
    els.btnCheck.disabled = false;
    els.waitlistBanner.classList.toggle("hidden", !IOU_CODES.includes(code));
  }else if(pending){
    pill.textContent = "PENDING";
    pill.classList.add("pill-pending");
    txt.textContent = code==="LADWP" ? "LADWP opens later in 2025." : "Select / detect a utility to continue.";
    els.btnCheck.disabled = true;
    els.waitlistBanner.classList.add("hidden");
  }else{
    pill.textContent = "CLOSED";
    pill.classList.add("pill-closed");
    txt.textContent = "Not accepting applications.";
    els.btnCheck.disabled = true;
    els.waitlistBanner.classList.add("hidden");
  }
  els.btnExport.disabled = true;
}

/* =======================
   VALIDATION
   ======================= */
function validate(){
  let ok=true;
  if(!els.customerType.value){
    els.customerTypeErr.textContent = "Please select a customer type.";
    els.customerTypeErr.classList.remove("hidden");
    ok=false;
  }else{
    els.customerTypeErr.classList.add("hidden");
    els.customerTypeErr.textContent="";
  }
  const cap = parseFloat(els.capacity.value);
  if(!Number.isFinite(cap) || cap<=0){
    els.capacityErr.textContent="Please provide a valid kWh (>0).";
    els.capacityErr.classList.remove("hidden");
    ok=false;
  }else{
    els.capacityErr.classList.add("hidden");
    els.capacityErr.textContent="";
  }
  return ok;
}

/* =======================
   ELIGIBILITY
   ======================= */
function eligibilityReason({amiPercent,care,inDAC}){
  if(typeof amiPercent==="number" && !isNaN(amiPercent) && amiPercent<=80) return "Income ‚â§ 80% AMI";
  if(care===true) return "CARE/FERA/ESA participation";
  if(inDAC===true) return "Address in Disadvantaged Community";
  return null;
}

/* =======================
   CALCULATE
   ======================= */
function calculate(){
  const squareFt = parseFloat(els.squareFootage.value) || 0;

  let cap = parseFloat(els.capacity.value);
  if(!Number.isFinite(cap) || cap<=0) cap = 15;

  let solar = parseFloat(els.solarCapacity.value);
  if(!Number.isFinite(solar) || solar<0) solar = 0;

  let autoPv = null;
  if(solar===0 && squareFt>0){
    autoPv = Math.max(1, squareFt * KW_PER_SQFT);
    solar = parseFloat(autoPv.toFixed(1));
  }

  const amiTxt = els.amiPercent.value.trim();
  const amiPercent = amiTxt ? Number(amiTxt) : null;
  const care = els.careProgram.value==="yes";
  const inDAC = els.inDAC.value==="yes";

  const storageIncentive = Math.round(cap * 1000 * RATES.storagePerWh); // kWh -> Wh
  const solarIncentive = Math.round(solar * RATES.solarPerkW);
  const total = storageIncentive + solarIncentive;

  const reason = eligibilityReason({amiPercent,care,inDAC});
  const equity = !!reason;

  const util = els.utility.value;
  const waitlist = IOU_CODES.includes(util);

  return {
    util, waitlist, equity, reason,
    cap, solar, autoPv, squareFt,
    storageIncentive, solarIncentive, total,
    amiPercent, care, inDAC
  };
}

function renderResult(d){
  const res = els.result;
  const lines = [];

  lines.push(`**Program status**`);
  lines.push(`‚Ä¢ Utility: ${d.util || "‚Äî"}`);
  if(d.waitlist) lines.push(`‚Ä¢ ‚ö†Ô∏è Possible waitlist due to high demand.`);
  lines.push("");

  lines.push(`**Your eligibility (auto‚Äëevaluated)**`);
  lines.push(`‚Ä¢ Equity‚Äëeligible: ${d.equity ? "Yes" : "No"}${d.equity ? ` (Reason: ${d.reason})` : ""}`);
  lines.push(`‚Ä¢ AMI %: ${typeof d.amiPercent==="number"&&!isNaN(d.amiPercent)? d.amiPercent.toFixed(1)+"%" : "not provided"}`);
  lines.push(`‚Ä¢ CARE/FERA/ESA: ${d.care ? "Yes" : "No/Unknown"}`);
  lines.push(`‚Ä¢ DAC: ${d.inDAC ? "Yes" : "No"}`);
  lines.push("");

  lines.push(`**Your inputs / assumptions**`);
  lines.push(`‚Ä¢ Storage: ${num1(d.cap)} kWh ‚Üí $${money0(d.storageIncentive)} @ $${money2(RATES.storagePerWh)} /Wh`);
  if(d.solar>0) lines.push(`‚Ä¢ Solar: ${num1(d.solar)} kW ‚Üí $${money0(d.solarIncentive)} @ $${money0(RATES.solarPerkW)} /kW`);
  if(d.autoPv) lines.push(`‚Ä¢ PV size auto‚Äëestimated from ${squareFtFmt(d.squareFt)} ft¬≤ @ 0.0035 kW/ft¬≤`);

  lines.push("");
  lines.push(`**Total SGIP incentives (est.)**`);
  lines.push(`$${money0(d.total)}`);

  lines.push("");
  lines.push(`**Advanced Payment**`);
  lines.push(`‚Ä¢ Up to 50% upfront through the SGIP Advanced Payment option.`);

  lines.push("");
  lines.push(`**Disclaimers**`);
  lines.push(`‚Ä¢ Advisory only; confirm with your SGIP Program Administrator.`);
  lines.push(`‚Ä¢ Incentive rates/budgets can change; waitlists may occur.`);

  const html = markdownishToHTML(lines.join("\n"));

  res.innerHTML = `
    <h3 style="margin-top:0;color:var(--secondary)">SGIP Residential Solar & Storage Equity ‚Äì Estimated Incentive</h3>
    <div>${html}</div>
    <div class="total-chip">Total: $${money0(d.total)}</div>
  `;
  res.classList.remove("hidden");
  els.btnExport.disabled = false;
  res.scrollIntoView({behavior:"smooth",block:"start"});
}

function squareFtFmt(v){ return Number(v).toLocaleString(); }

// ultra-lite markdown-ish (bold only)
function markdownishToHTML(txt){
  return txt
   .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
   .replace(/\n/g,"<br>");
}

/* =======================
   ARCGIS HELPERS
   ======================= */
async function fetchJSON(url){
  return withTimeout(fetch(url), CONFIG.timeouts.fetch, url).then(r=>{
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    return r.json();
  });
}

async function geocodeAddress(addr){
  const p = new URLSearchParams({
    SingleLine: addr,
    outFields: "Match_addr,Addr_type",
    f: "json"
  });
  const url = `${CONFIG.geocodeUrl}?${p}`;
  const j = await fetchJSON(url);
  const c = j.candidates?.[0];
  if(!c) throw new Error("No geocode candidate found");
  return {x:c.location.x, y:c.location.y, score:c.score, address:c.address};
}

async function pointInLayer(point, url){
  if(!url) return null;
  const p = new URLSearchParams({
    f:"json",
    geometry: JSON.stringify({x:point.x,y:point.y, spatialReference:{wkid:4326}}),
    geometryType:"esriGeometryPoint",
    inSR:"4326",
    spatialRel:"esriSpatialRelIntersects",
    outFields:"*",
    returnGeometry:"false"
  });
  const j = await fetchJSON(`${url}?${p}`);
  return (j.features||[])[0] || null;
}

async function pointInAnyLayer(point, urls=[]){
  for(const u of urls){
    try{
      const f = await pointInLayer(point,u);
      if(f) return f;
    }catch(e){
      console.warn("Layer failed",u,e);
    }
  }
  return null;
}

async function detectUtility(point){
  if(!CONFIG.paTerritoriesUrl) return null;
  try{
    const f = await pointInLayer(point, CONFIG.paTerritoriesUrl);
    if(!f) return null;
    const code = f.attributes?.[CONFIG.paField];
    return code || null;
  }catch(e){
    console.warn("PA detect failed", e);
    return null;
  }
}

/* =======================
   HUD
   ======================= */
async function fetchHud(zip, year, key){
  if(!key) throw new Error("Missing HUD API key in CONFIG.hud.apiKey");
  const url = `${CONFIG.hud.baseZipUrl}/${zip}?year=${year}`;
  const r = await withTimeout(fetch(url,{headers:{Authorization:`Bearer ${key}`}}), CONFIG.timeouts.fetch, "HUD");
  if(!r.ok) throw new Error(`HUD HTTP ${r.status}`);
  return r.json();
}
function hudPctFromMFI(json, income){
  const d = json?.data?.[0];
  if(!d || typeof d.medianFamilyIncome!=="number") throw new Error("No MFI in HUD response");
  return (income / d.medianFamilyIncome) * 100;
}

/* =======================
   MINI MAP
   ======================= */
let miniMap, miniMarker;
function updateMap(lat,lon){
  els.miniMap.classList.remove("hidden");
  if(!miniMap){
    miniMap = L.map(els.miniMap).setView([lat,lon],14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom:19, attribution:"&copy; OpenStreetMap"
    }).addTo(miniMap);
    miniMarker = L.marker([lat,lon]).addTo(miniMap);
  }else{
    miniMap.setView([lat,lon],14);
    miniMarker.setLatLng([lat,lon]);
  }
}

/* =======================
   EXPORT
   ======================= */
function exportPDF(){
  const w = window.open("", "_blank");
  w.document.write(`
    <html><head><meta charset="utf-8"><title>SGIP Incentive Summary</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;color:#111;line-height:1.6;}
        h1{font-size:1.4rem;margin:0 0 1rem;color:#0f172a;}
        .muted{color:#666;font-size:.875rem;margin-top:1.5rem;}
      </style>
    </head>
    <body>
      <h1>SGIP Incentive Summary</h1>
      ${els.result.innerHTML}
      <div class="muted">Advisory only. Confirm with your Program Administrator.</div>
    </body></html>
  `);
  w.document.close(); w.focus(); w.print();
}

/* =======================
   INIT
   ======================= */
document.addEventListener("DOMContentLoaded",()=>{
  setUtilityStatus("");

  els.utility.addEventListener("change",()=>setUtilityStatus(els.utility.value));

  els.hudFetchBtn.addEventListener("click", async ()=>{
    els.hudStatus.textContent="";
    const zip = els.hudZip.value.trim();
    const income = parseFloat(els.hudIncome.value);
    if(zip.length!==5){ els.hudStatus.textContent="Enter a 5-digit ZIP."; return; }
    if(!Number.isFinite(income) || income<=0){ els.hudStatus.textContent="Enter valid income."; return; }
    try{
      els.hudStatus.textContent="Fetching HUD...";
      const json = await fetchHud(zip, CONFIG.hud.year, CONFIG.hud.apiKey);
      const pct = hudPctFromMFI(json, income);
      els.amiPercent.value = pct.toFixed(1);
      els.hudStatus.textContent = `Estimated AMI% = ${pct.toFixed(1)}% (income √∑ MFI √ó 100).`;
    }catch(e){
      console.error(e);
      els.hudStatus.textContent = `HUD error: ${e.message}`;
    }
  });

  els.checkAddressBtn.addEventListener("click", async ()=>{
    const raw = els.addressInput.value.trim();
    if(!raw){
      setAddrStatus("Enter an address first."); return;
    }
    const key = raw.toLowerCase();
    if(addressCache[key]){
      useCached(addressCache[key]);
      return;
    }

    try{
      setAddrStatus("Geocoding address‚Ä¶");
      const pt = await geocodeAddress(raw);
      updateMap(pt.y, pt.x);

      // Layer checks
      const statuses = [];
      let dac=false,fire=false,psps=false,utility=null;

      setAddrStatus("Checking DAC / Fire / PSPS layers‚Ä¶");
      try{
        dac = !!await pointInLayer(pt, CONFIG.sb535Url);
        statuses.push(`DAC: ${dac?"Yes":"No"}`);
      }catch(e){ statuses.push("DAC check failed: "+e.message); }
      try{
        fire = !!await pointInAnyLayer(pt, CONFIG.wildfireTierUrls);
        statuses.push(`Fire 2/3: ${fire?"Yes":"No"}`);
      }catch(e){ statuses.push("Fire check failed: "+e.message); }
      try{
        psps = !!await pointInLayer(pt, CONFIG.pspsUrl);
        statuses.push(`PSPS: ${psps?"Yes":"No"}`);
      }catch(e){ statuses.push("PSPS check failed: "+e.message); }

      try{
        if(CONFIG.paTerritoriesUrl){
          setAddrStatus("Detecting Program Administrator territory‚Ä¶");
          utility = await detectUtility(pt);
          if(utility){
            els.utility.value = utility;
            setUtilityStatus(utility);
          }
          statuses.push(`Utility: ${utility || "‚Äî"}`);
        }
      }catch(e){
        statuses.push("Utility detect failed: "+e.message);
      }

      // reflect in selects
      els.inDAC.value = dac ? "yes":"no";
      els.inFire.value = fire ? "yes":"no";
      els.inPSPS.value = psps ? "yes":"no";

      setAddrStatus(`(${pt.y.toFixed(5)}, ${pt.x.toFixed(5)})\n`+statuses.join("\n"),
        [utility||"", dac?"DAC":"", fire?"Tier 2/3":"", psps?"PSPS":""].filter(Boolean));

      addressCache[key]={lat:pt.y,lon:pt.x,dac,fire,psps,utility};
      try{ localStorage.setItem(ADDRESS_CACHE_KEY, JSON.stringify(addressCache)); }catch{}

    }catch(e){
      console.error(e);
      setAddrStatus(
        "Address check failed.\n"+
        "Step failed: "+(e.message||e)+
        "\nConfirm ArcGIS URLs, PA URL/field, and CORS/network in DevTools."
      );
    }
  });

  els.clearAddressBtn.addEventListener("click", ()=>{
    els.addressInput.value="";
    els.addressStatus.classList.add("hidden");
    els.addressStatus.innerHTML="";
    els.miniMap.classList.add("hidden");
    els.inDAC.value="";
    els.inFire.value="";
    els.inPSPS.value="";
  });

  els.form.addEventListener("submit",(e)=>{
    e.preventDefault();
    const util = els.utility.value;
    const open = (IOU_CODES.includes(util) && isAfterOrEqual(todayISO(),CONFIG.openDates.IOUs)) || util==="OTHER";
    if(!open){
      alert("Selected utility not open yet for this program.");
      return;
    }
    if(!validate()){ els.result.classList.add("hidden"); return; }
    const data = calculate();
    renderResult(data);
  });

  els.btnExport.addEventListener("click", ()=> exportPDF());

  els.btnReset.addEventListener("click", resetAll);

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape") resetAll();
  });

  function resetAll(){
    els.form.reset();
    els.result.classList.add("hidden");
    els.btnExport.disabled = true;
    els.btnCheck.disabled = true;
    setUtilityStatus("");
  }

  function setAddrStatus(msg, badges=[]){
    const box = els.addressStatus;
    box.innerHTML = `
      ${badges.map(b=>`<span class="badge">${b}</span>`).join(" ")}
      ${msg}
    `;
    box.classList.remove("hidden");
  }

  function useCached(c){
    setAddrStatus(
      `[cached]\n(${c.lat.toFixed(5)}, ${c.lon.toFixed(5)})\nUtility: ${c.utility||"‚Äî"}\nDAC: ${c.dac?"Yes":"No"} ‚Ä¢ Fire 2/3: ${c.fire?"Yes":"No"} ‚Ä¢ PSPS: ${c.psps?"Yes":"No"}`,
      [c.utility||"", c.dac?"DAC":"", c.fire?"Tier 2/3":"", c.psps?"PSPS":""].filter(Boolean)
    );
    els.inDAC.value = c.dac?"yes":"no";
    els.inFire.value = c.fire?"yes":"no";
    els.inPSPS.value = c.psps?"yes":"no";
    if(c.utility){
      els.utility.value = c.utility;
      setUtilityStatus(c.utility);
    }
    updateMap(c.lat,c.lon);
  }
});
</script>
</body>
</html>

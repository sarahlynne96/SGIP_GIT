<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SGIP Eligibility & Rebate Estimator</title>
  <style>
    :root{
      --primary:#fdb813;--secondary:#003c71;--accent:#005eb8;--bg:#f9f9f9;--text:#333;--muted:#666;--success:#1b8f3b;--danger:#c00;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);line-height:1.45;padding-bottom:4rem;}
    h1{font-size:2rem;font-weight:700;color:var(--primary);text-align:center;margin:1.4rem 0;}
    a{color:var(--accent);}  

    /* ---------- CALCULATOR CARD ---------- */
    .wrapper{max-width:800px;margin:0 auto;padding:0 1rem;}
    form>div{margin-bottom:18px;}
    label{display:block;font-weight:600;color:var(--secondary);margin-bottom:6px;font-size:1rem;}
    select,input{width:100%;padding:10px;border:1px solid #ccc;border-radius:4px;font-size:1rem;}
    small{display:block;margin-top:4px;color:var(--muted);font-size:.85rem;}
    button{display:block;width:100%;background:var(--primary);color:#fff;border:none;padding:12px 20px;font-size:1rem;border-radius:4px;font-weight:600;cursor:pointer;transition:background .3s ease;}button:hover{background:var(--accent);}button:disabled{opacity:.6;cursor:not-allowed;}

    #result{display:none;margin-top:22px;padding:18px;background:#fff;border-left:5px solid var(--primary);border-radius:4px;font-size:1rem;}
    #result h3{margin-top:0;color:var(--secondary);}#result p{margin:.65rem 0;}
    .card{border:1px solid #ddd;border-radius:6px;margin-top:1rem;padding:1rem;}
    details{border:1px solid #e1e1e1;border-radius:6px;margin-top:1rem;padding:.75rem;}details[open]{border-color:var(--secondary);}summary{cursor:pointer;font-weight:600;outline:none;}
    .badge{display:inline-block;background:var(--secondary);color:#fff;padding:0.25rem 0.55rem;border-radius:3px;font-size:.78rem;margin-right:6px;}
    .tag-ok{color:var(--success);} .tag-no{color:var(--danger);}  

    /* ---------- MAP BOXES AT FOOTER ---------- */
    .maps{margin:3rem auto 0;max-width:1100px;padding:0 1rem;}
    .map-box{border:1px solid var(--accent);border-radius:6px;overflow:hidden;margin-bottom:24px;background:#fff;}
    .map-box h2{background:var(--secondary);color:#fff;font-size:1rem;font-weight:600;padding:10px;}
    .map-box iframe{width:100%;height:380px;border:0;}

    footer{text-align:center;font-size:.85rem;padding:1.5rem 0;color:var(--muted);}  
  </style>
</head>
<body>
  <h1>California SGIP Rebate Estimator</h1>
  <div class="wrapper">
    <p style="margin:0 0 1rem;font-size:.95rem;color:var(--muted);">Answer the quick questions below (estimates are fine). Hit <strong>Calculate</strong> to see which SGIP program fits you best and how much you could receive.</p>
    <form id="calcForm" novalidate>
      <div>
        <label for="utility">1. Which utility serves the site?</label>
        <select id="utility" required>
          <option value="">Choose…</option>
          <option>CSE</option><option>SCE</option><option>SCG</option><option>PG&E</option><option>LADWP</option>
        </select>
      </div>
      <div>
        <label for="custType">2. What type of customer are you?</label>
        <select id="custType" required>
          <option value="">Choose…</option>
          <option value="single">Home – Single-Family</option>
          <option value="multi">Home – Multifamily (5+ units)</option>
          <option value="nonres">Business / Non-Residential</option>
        </select>
      </div>
      <div>
        <label for="dacFlag">3. Is your address in a Disadvantaged Community (DAC) or High Fire-Threat District (HFTD)?</label>
        <select id="dacFlag" required><option value="">Choose…</option><option value="yes">Yes</option><option value="no">No / Not sure</option></select>
        <small>Tip: use the map links at the bottom if you’re unsure.</small>
      </div>
      <div>
        <label for="pspsFlag">4. Has your location experienced recent PSPS shut-offs?</label>
        <select id="pspsFlag" required><option value="">Choose…</option><option value="yes">Yes</option><option value="no">No / Unsure</option></select>
      </div>
      <div>
        <label for="incomeFlag">5. Do you qualify for CARE / FERA or is household income ≤ 80 % AMI?</label>
        <select id="incomeFlag" required><option value="">Choose…</option><option value="yes">Yes</option><option value="no">No / Unsure</option></select>
      </div>
      <div>
        <label for="critFlag">6. Medical baseline customer or essential well-pump?</label>
        <select id="critFlag" required><option value="">Choose…</option><option value="yes">Yes</option><option value="no">No</option></select>
      </div>
      <div>
        <label for="storageKWh">7. Planned battery size in kWh</label>
        <input type="number" id="storageKWh" min="0" step="0.1" placeholder="e.g. 20" required>
      </div>
      <div>
        <label for="solarKW">8. Solar PV size in kW <em>(optional)</em></label>
        <input type="number" id="solarKW" min="0" step="0.1" placeholder="e.g. 6">
      </div>
      <div>
        <label for="backupFlag">9. Will the system power your home/business during an outage?</label>
        <select id="backupFlag" required><option value="">Choose…</option><option value="yes">Yes – Backup capable</option><option value="no">No</option></select>
      </div>
      <button id="btnCalc" type="button">Calculate</button>
    </form>

    <div id="result"></div>
  </div>

  <!-- -------------- MAPS -------------- -->
  <section class="maps">
    <div class="map-box">
      <h2>SB 535 Disadvantaged Communities Map</h2>
      <iframe title="DAC Map" loading="lazy" src="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities?embed=true"></iframe>
    </div>
    <div class="map-box">
      <h2>Wildfire Threat & PSPS Status Tools</h2>
      <p style="padding:10px;font-size:.95rem;">
        • <a href="https://ia.cpuc.ca.gov/firethreatmap/" target="_blank">CPU﻿C Fire-Threat District Map</a><br>
        • <a href="https://www.sce.com/outage-center/check-outage-status" target="_blank">SCE Public-Safety Shutoff Lookup</a>
      </p>
    </div>
  </section>

  <footer>
    Rates per <a href="https://www.cpuc.ca.gov/sgip" target="_blank">CPUC SGIP</a> (updated July 2025, unofficial tool).
  </footer>

  <script>
    /* ---------- RATE TABLE (July 2025 current step) ---------- */
    const RATE_TABLE={
      largeScale:{CSE:.25,SCE:.25,SCG:.25,'PG&E':.25,LADWP:.25},
      smallRes:{CSE:.15,SCE:.15,SCG:.15,'PG&E':.15,LADWP:.15},
      equityStorage:{CSE:.85,SCE:.85,SCG:.85,'PG&E':.85,LADWP:.85},
      equitySolarStorage:{CSE:1.10,SCE:1.10,SCG:1.10,'PG&E':1.10,LADWP:1.10},
      equitySolarAdder:{CSE:3.10,SCE:3.10,SCG:3.10,'PG&E':3.10,LADWP:3.10},
      equityResiliency:{CSE:1.00,SCE:1.00,SCG:1.00,'PG&E':1.00,LADWP:1.00},
      gen:{CSE:2.00,SCE:2.00,SCG:2.00,'PG&E':2.00,LADWP:2.00},
      genResiliency:{CSE:4.50,SCE:4.50,SCG:4.50,'PG&E':4.50,LADWP:4.50}
    };

    /* ---------- PROGRAMS ---------- */
    function makePrograms(utility){
      const r=RATE_TABLE; // shorthand
      return [
        {
          name:'Residential Solar + Storage Equity',badge:'Equity S+S',category:'res',
          rateText:`${fmt(r.equitySolarStorage[utility])}/Wh + ${fmt(r.equitySolarAdder[utility])}/W`,
          blurb:'Highest incentive for income-qualified homes pairing batteries with solar.',
          requirements:['Income ≤80% AMI or CARE/FERA','Single-family or multifamily residence'],
          docs:['Income proof or CARE/FERA bill','SGIP application package'],
          eligibility:u=>u.res&&u.income,
          calc:u=>u.stWh*r.equitySolarStorage[utility]+u.solW*r.equitySolarAdder[utility]
        },
        {
          name:'Residential Equity – Storage Only',badge:'Equity Storage',category:'res',
          rateText:`${fmt(r.equityStorage[utility])}/Wh`,
          blurb:'Low-income homes installing a standalone battery.',
          requirements:['Income qualification as above'],docs:['Same as above'],
          eligibility:u=>u.res&&u.income,
          calc:u=>u.stWh*r.equityStorage[utility]
        },
        {
          name:'Equity Resiliency',badge:'Equity Resiliency',category:'res',
          rateText:`${fmt(r.equityResiliency[utility])}/Wh`,
          blurb:'Homes in Fire-Threat or PSPS zones needing backup.',
          requirements:['HFTD Tier 2/3 or ≥2 PSPS events','Income qualifier OR medical baseline / well-pump'],docs:['Resiliency Attestation'],
          eligibility:u=>u.res&&(u.psps||u.hftd||u.medical)&&u.income,
          calc:u=>u.stWh*r.equityResiliency[utility]
        },
        {
          name:'Small Residential – General Market',badge:'Small Res',category:'res',
          rateText:`${fmt(r.smallRes[utility])}/Wh`,
          blurb:'Base incentive for homes ≤30 kWh not in Equity budgets.',
          requirements:['Battery ≤30 kWh'],docs:['Standard SGIP docs'],
          eligibility:u=>u.res&&!u.income&&u.stKWh<=30,
          calc:u=>u.stWh*r.smallRes[utility]
        },
        {
          name:'Large-Scale Commercial',badge:'Large Storage',category:'nonres',
          rateText:`${fmt(r.largeScale[utility])}/Wh`,
          blurb:'General market storage for businesses (>30 kWh).',
          requirements:['Commercial / industrial system'],docs:['PBI metering plan'],
          eligibility:u=>u.nonres,
          calc:u=>u.stWh*r.largeScale[utility]
        },
        {
          name:'Commercial Resiliency Adder',badge:'Non-Res Resiliency',category:'nonres',
          rateText:`${fmt(r.largeScale[utility]+0.15)}/Wh`,
          blurb:'Business critical facilities in PSPS / HFTD zones.',
          requirements:['Critical facility or PSPS/HFTD site'],docs:['Resiliency Attestation'],
          eligibility:u=>u.nonres&&(u.psps||u.hftd||u.medical||u.crit),
          calc:u=>u.stWh*(r.largeScale[utility]+0.15)
        },
        {
          name:'Renewable Generation',badge:'Generation',category:'gen',
          rateText:`${fmt(r.gen[utility])}/W`,
          blurb:'Wind, bio-gas, or PV ≥10 kW at non-residential sites.',
          requirements:['Qualifying renewable tech ≤3 MW'],docs:['Tech spec sheets'],
          eligibility:u=>u.solKW>0,
          calc:u=>u.solW*r.gen[utility]
        },
        {
          name:'Generation Resiliency Adder',badge:'Gen Resiliency',category:'gen',
          rateText:`${fmt(r.genResiliency[utility])}/W`,
          blurb:'Critical facilities adding islanding capability.',
          requirements:['Critical facility in PSPS / HFTD'],docs:['Resiliency Attestation'],
          eligibility:u=>u.solKW>0&&(u.psps||u.hftd||u.crit),
          calc:u=>u.solW*r.genResiliency[utility]
        }
      ];
    }

    /* ---------- UTIL ---------- */
    const $=q=>document.querySelector(q);
    const fmtUSD=v=>v.toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0});
    const fmt=v=>`$${v.toFixed(2)}`;

    /* ---------- MAIN ---------- */
    $('#btnCalc').addEventListener('click',()=>{
      /* collect input */
      const u={
        utility:$('#utility').value,
        cust:$('#custType').value,
        hftd:$('#dacFlag').value==='yes',
        psps:$('#pspsFlag').value==='yes',
        income:$('#incomeFlag').value==='yes',
        medical:$('#critFlag').value==='yes',
        stKWh:parseFloat($('#storageKWh').value||0),
        solKW:parseFloat($('#solarKW').value||0)
      };
      if(!u.utility){alert('Please choose your utility company.');return;}
      if(!u.stKWh){alert('Please enter a battery size to continue.');return;}
      u.res=(u.cust==='single'||u.cust==='multi');
      u.nonres=(u.cust==='nonres');
      u.crit=u.medical;
      u.stWh=u.stKWh*1000;
      u.solW=u.solKW*1000;

      const PROGRAMS=makePrograms(u.utility);

      const eligible=PROGRAMS.filter(p=>p.eligibility(u)).map(p=>({...p,reward:p.calc(u)}));
      const best=eligible.sort((a,b)=>b.reward-a.reward)[0];

      const resEl=$('#result');
      if(!best){resEl.innerHTML='<p>No SGIP budget appears to match these inputs. Double-check your answers or contact your Program Administrator.</p>';resEl.style.display='block';return;}

      let html=`<h3>You appear to qualify for the <strong>${best.name}</strong> program.</h3>`;
      html+=`<p>${best.blurb}</p>`;
      html+=`<p>• <strong>Incentive rate:</strong> ${best.rateText}<br>• <strong>Estimated rebate:</strong> <span style="color:var(--primary);font-weight:600;">${fmtUSD(best.reward)}</span></p>`;
      html+=`<p>This estimate is based on <strong>${u.stKWh.toLocaleString()} kWh</strong> of battery storage${u.solKW?` and <strong>${u.solKW.toLocaleString()} kW</strong> of solar PV`:''}. Actual reservation depends on step availability, equipment specs & CPUC verification.</p>`;

      html+=`<div class="card"><strong>Documentation checklist:</strong><ul style="margin:.5rem 0 .5rem 1.1rem;">${best.docs.map(d=>`<li>${d}</li>`).join('')}</ul></div>`;

      html+=`<details><summary style="margin-top:1rem;">See your status across all SGIP buckets</summary>`;
      PROGRAMS.forEach(p=>{
        const ok=eligible.find(e=>e.name===p.name);
        html+=`<div style="margin-top:1rem;"><span class="badge">${p.badge}</span> ${p.name} – <span class="${ok?'tag-ok':'tag-no'}">${ok?'Eligible':'Not Eligible'}</span></div>`;
      });
      html+='</details>';

      resEl.innerHTML=html;
      resEl.style.display='block';
      resEl.scrollInto

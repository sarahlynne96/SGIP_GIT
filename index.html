<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>SGIP Residential Solar & Storage Equity Calculator</title>

  <!-- Leaflet for the small map preview -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o9N1j7kGStG3v3lR82GkGzm1G3S2MKCkG4ZkT2f0Xpw="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStG3v3lR82GkGzm1G3S2MKCkG4ZkT2f0Xpw="
    crossorigin=""
    defer
  ></script>

  <style>
    :root {
      --color-primary: #fdb813;
      --color-secondary: #003c71;
      --color-accent: #005eb8;

      --color-bg: #f7f7f7;
      --color-surface: #ffffff;
      --color-text: #1f1f1f;
      --color-text-muted: #666;
      --color-border: #e5e5e5;
      --color-error: #c0392b;
      --color-warn: #b65e00;

      --focus-ring: 3px solid #005eb8;

      --fs-base: 1rem;
      --fs-sm: 0.875rem;
      --fs-lg: 1.125rem;
      --fs-xl: clamp(1.25rem, 3vw, 1.75rem);

      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.5rem;
      --space-6: 2rem;

      --radius: 0.5rem;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.08);
      --transition: 160ms ease;
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { min-height: 100%; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      font-size: var(--fs-base);
      line-height: 1.5;
    }

    a { color: var(--color-accent); text-decoration: none; }
    a:hover, a:focus { text-decoration: underline; }

    h1, h2, h3 { line-height: 1.2; margin: 0 0 var(--space-3); }
    .section-title { font-size: var(--fs-lg); color: var(--color-secondary); margin-bottom: var(--space-3); }

    .skip-link { position: absolute; left: -999px; top: -999px; }
    .skip-link:focus { position: static; background: var(--color-accent); color: #fff; padding: var(--space-2) var(--space-3); }

    .site-header, .site-footer {
      padding: var(--space-4);
      background: var(--color-surface);
      box-shadow: var(--shadow-sm);
    }
    .site-title {
      font-size: var(--fs-xl);
      text-align: center;
      color: var(--color-primary);
      margin: 0;
    }

    /* LAYOUT: calculator first, maps last (bottom). On desktop, calc sticks right, maps span full width below */
    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-5);
      max-width: 1300px;
      padding: var(--space-4);
      margin: 0 auto;
    }
    @media (min-width: 1024px) {
      .container {
        grid-template-columns: 1fr 420px;
        grid-template-areas:
          "main calc"
          "maps maps";
        column-gap: var(--space-5);
      }
      .main-content   { grid-area: main; }
      .calculator-wrap{ grid-area: calc; }
      .maps           { grid-area: maps; }
    }
    @media (max-width: 1023px) {
      .main-content, .calculator-wrap, .maps {
        grid-area: auto;
      }
      .calculator-wrap { order: 1; }
      .main-content    { order: 2; }
      .maps            { order: 3; }
    }

    .map-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: var(--space-4);
    }
    .map-card__title {
      padding: var(--space-3) var(--space-4);
      background: var(--color-secondary);
      color: #fff;
      font-size: var(--fs-base);
    }
    .map-card__actions {
      padding: var(--space-2) var(--space-4) 0;
      font-size: var(--fs-sm);
    }
    .map-card iframe {
      width: 100%;
      height: 400px;
      border: 0;
      display: block;
    }

    .calculator {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: var(--space-4);
      position: sticky;
      top: var(--space-4);
      max-height: calc(100vh - 2 * var(--space-4));
      overflow-y: auto;
    }

    .banner-warn {
      border-left: 4px solid var(--color-primary);
      background: #fff3da;
      padding: var(--space-3);
      margin-bottom: var(--space-4);
      color: var(--color-warn);
      font-weight: 600;
    }

    .budget-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--space-4);
      font-size: var(--fs-sm);
    }
    .budget-table th, .budget-table td {
      border: 1px solid var(--color-border);
      padding: var(--space-2) var(--space-3);
      text-align: left;
    }
    .budget-table thead {
      background: var(--color-secondary);
      color: #fff;
    }

    .status-pill {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
    }
    .status-open { background: #2e7d32; }
    .status-closed { background: #b71c1c; }
    .status-pending { background: #f9a825; color: #000; }

    .form-field { margin-bottom: var(--space-4); }
    label {
      display: block;
      font-weight: 600;
      color: var(--color-secondary);
      margin-bottom: var(--space-2);
    }

    input, select, button { font-size: var(--fs-base); line-height: 1.2; }
    input, select {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: transparent;
      color: inherit;
      transition: border-color var(--transition), box-shadow var(--transition);
      min-height: 44px;
    }
    input:focus, select:focus, button:focus { outline: var(--focus-ring); outline-offset: 2px; }

    .help { display: block; color: var(--color-text-muted); margin-top: var(--space-2); font-size: var(--fs-sm); }
    .error { color: var(--color-error); font-size: var(--fs-sm); margin: var(--space-2) 0 0; }

    .form-actions { display: flex; gap: var(--space-3); flex-wrap: wrap; }

    button {
      border: none;
      border-radius: var(--radius);
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      transition: background var(--transition), transform var(--transition);
      min-height: 44px;
    }
    button:active { transform: translateY(1px); }
    .btn-primary { background: var(--color-primary); color: #000; }
    .btn-primary:hover { background: #ffcc4a; color: #000; }
    .btn-secondary { background: transparent; border: 1px solid var(--color-border); color: inherit; }
    .btn-secondary:hover { background: var(--color-border); }

    .result {
      margin-top: var(--space-5);
      padding: var(--space-4);
      background: var(--color-surface);
      border-left: 5px solid var(--color-primary);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      font-size: var(--fs-base);
      line-height: 1.5;
      white-space: pre-line;
    }

    .address-check {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: var(--space-4);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-4);
    }
    .address-status {
      margin-top: var(--space-3);
      padding: var(--space-3);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius);
      font-size: var(--fs-sm);
      background: #fff9ec;
      white-space: pre-line;
    }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.25rem;
      color: #000;
      background: var(--color-primary);
    }

    #miniMap {
      height: 250px;
      margin-top: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <header class="site-header" role="banner">
    <h1 class="site-title">SGIP Residential Solar &amp; Storage Equity Calculator</h1>
  </header>

  <main id="main" class="container" role="main">
    <!-- MAIN CONTENT (blank slot if you want to add explainer text later) -->
    <section class="main-content" aria-label="intro">
      <!-- You can add a hero / explainer here if you like -->
    </section>

    <!-- CALCULATOR (RIGHT ON DESKTOP) -->
    <aside class="calculator-wrap" aria-labelledby="calc-heading">
      <div class="calculator">
        <h2 id="calc-heading" class="section-title">Calculator</h2>

        <!-- Budget & waitlist banner -->
        <div id="waitlistBanner" class="banner-warn hidden">
          ‚ö†Ô∏è High demand expected ‚Äî your utility territory may **waitlist** applications once funds are claimed.
        </div>

        <table class="budget-table" aria-describedby="budget-note">
          <thead>
            <tr>
              <th>Budget Bucket</th>
              <th>Total Budget</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Storage Incentives</td>
              <td>$280,000,000</td>
            </tr>
            <tr>
              <td>Solar Incentives</td>
              <td>$18,000,000</td>
            </tr>
          </tbody>
        </table>
        <p id="budget-note" class="help">
          *Static totals shown. Territories may waitlist when demand exceeds remaining funds.
        </p>

        <!-- Utility + gating (auto-detected if you use PA polygons) -->
        <div class="form-field">
          <label for="utility">Utility Territory (auto-detected from address if possible)</label>
          <select id="utility" name="utility" aria-describedby="utility-status">
            <option value="">Select or auto-detect below</option>
            <option value="PGE">PG&amp;E</option>
            <option value="SCE">SCE</option>
            <option value="SDGE">SDG&amp;E</option>
            <option value="SCG">SoCalGas</option>
            <option value="LADWP">LADWP</option>
            <option value="OTHER">Other</option>
          </select>
          <div id="utility-status" class="help" style="margin-top: .5rem;">
            Status: <span id="utilityStatusPill" class="status-pill status-pending">Select / detect</span>
            <span id="utilityStatusText"></span>
          </div>
        </div>

        <!-- Address checker -->
        <section class="address-check" aria-labelledby="addr-title">
          <h3 id="addr-title">Quick Address Check (DAC / Fire Tier 2-3 / PSPS / Utility)</h3>

          <div class="form-field">
            <label for="addressInput">Address</label>
            <input id="addressInput" type="text" placeholder="123 Main St, City, CA" autocomplete="street-address" />
          </div>

          <div class="form-actions">
            <button type="button" id="checkAddressBtn" class="btn-primary">Check Address</button>
            <button type="button" id="clearAddressBtn" class="btn-secondary">Clear</button>
          </div>

          <div id="addressStatus" class="address-status hidden" role="status" aria-live="polite"></div>
          <div id="miniMap" class="hidden" aria-label="Address preview map"></div>

          <small class="help">
            Uses ArcGIS REST queries. Results are advisory only‚Äîconfirm with official tools.
          </small>
        </section>

        <!-- Income auto-fill with HUD -->
        <section class="address-check" aria-labelledby="hud-title">
          <h3 id="hud-title">Income Auto‚ÄëFill (HUD)</h3>

          <div class="form-field">
            <label for="hudZip">ZIP Code</label>
            <input id="hudZip" type="text" inputmode="numeric" pattern="\\d{5}" placeholder="e.g., 90001" />
          </div>

          <div class="form-field">
          <label for="hudHousehold">Household Size</label>
            <input id="hudHousehold" type="number" min="1" step="1" value="4" />
          </div>

          <div class="form-field">
            <label for="hudIncome">Annual Household Income ($)</label>
            <input id="hudIncome" type="number" min="0" step="100" placeholder="e.g., 55000" />
          </div>

          <div class="form-actions">
            <button type="button" id="hudFetchBtn" class="btn-primary">Fetch & auto‚Äëfill AMI%</button>
          </div>

          <div id="hudStatus" class="help" role="status" aria-live="polite"></div>
          <small class="help">
            Requires a HUD USER API key. We approximate AMI% as income √∑ Median Family Income (MFI) √ó 100.
          </small>
        </section>

        <form id="calcForm" novalidate data-testid="calc-form">
          <!-- 1 -->
          <div class="form-field" data-required>
            <label for="customerType">1. Host Customer Class</label>
            <select id="customerType" name="customerType" data-testid="customerType" required aria-describedby="customerType-help">
              <option value="">Select type</option>
              <option value="residential-single">Residential Single-Family</option>
              <option value="residential-multi">Residential Multifamily</option>
              <option value="commercial">Commercial/Business</option>
              <option value="industrial">Industrial/Agricultural</option>
            </select>
            <small id="customerType-help" class="help">
              Must be utility customer of record; rentals need explanation letter.
            </small>
            <p class="error" id="customerType-error" hidden></p>
          </div>

          <!-- 2 -->
          <div class="form-field">
            <label for="inDAC">2. Disadvantaged Community (DAC)?</label>
            <select id="inDAC" name="inDAC" data-testid="inDAC">
              <option value=""></option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>

          <!-- 3 -->
          <div class="form-field">
            <label for="inFire">3. Tier 2/3 Wildfire Threat Zone?</label>
            <select id="inFire" name="inFire" data-testid="inFire">
              <option value=""></option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>

          <!-- 4 -->
          <div class="form-field">
            <label for="inPSPS">4. Located in a PSPS Shutoff Area?</label>
            <select id="inPSPS" name="inPSPS" data-testid="inPSPS" aria-describedby="inPSPS-help">
              <option value=""></option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
            <small id="inPSPS-help" class="help">
              Refer to CPUC PSPS lookup tool separate from this calculator.
            </small>
          </div>

          <!-- 5 -->
          <div class="form-field">
            <label for="amiPercent">5. Household income as % of AMI (auto‚Äëfilled or manual)</label>
            <input
              type="number"
              id="amiPercent"
              name="amiPercent"
              min="0"
              max="300"
              step="0.1"
              placeholder="e.g., 60 (means 60% of AMI)"
            />
            <small class="help">
              If ‚â§ 80%, you‚Äôre considered low‚Äëincome for SGIP Equity.
            </small>
          </div>

          <!-- 6 -->
          <div class="form-field">
            <label for="careProgram">6. Participates in CARE / FERA / ESA?</label>
            <select id="careProgram" name="careProgram" data-testid="careProgram">
              <option value=""></option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
              <option value="unsure">Unsure</option>
            </select>
          </div>

          <!-- 7 -->
          <div class="form-field">
            <label for="squareFootage">7. Home Square Footage (optional)</label>
            <input
              type="number"
              id="squareFootage"
              name="squareFootage"
              min="0"
              placeholder="e.g., 2000"
              inputmode="numeric"
              data-testid="squareFootage"
            />
            <small class="help">
              If Solar PV size is blank, we‚Äôll estimate using 0.0035&nbsp;kW per ft¬≤ (‚âà 7&nbsp;kW for 2,000&nbsp;ft¬≤).
            </small>
          </div>

          <!-- 8 -->
          <div class="form-field" data-required>
            <label for="capacity">8. Storage Capacity (kWh)</label>
            <input
              type="number"
              id="capacity"
              name="capacity"
              min="0"
              step="0.1"
              value="15"
              placeholder="Default 15 kWh"
              inputmode="decimal"
              required
              data-testid="capacity"
            />
            <p class="error" id="capacity-error" hidden></p>
          </div>

          <!-- 9 -->
          <div class="form-field">
            <label for="solarCapacity">9. Solar PV Capacity (kW)</label>
            <input
              type="number"
              id="solarCapacity"
              name="solarCapacity"
              min="0"
              step="0.1"
              value="5"
              placeholder="Default 5 kW (or leave blank)"
              inputmode="decimal"
              data-testid="solarCapacity"
            />
          </div>

          <!-- 10 -->
          <div class="form-field">
            <label for="backup">10. Backup Capability?</label>
            <select id="backup" name="backup" data-testid="backup">
              <option value=""></option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="submit" id="btnCheck" class="btn-primary" data-testid="calculate" disabled>
              Calculate SGIP Incentive
            </button>
            <button type="button" id="btnExport" class="btn-secondary" disabled>
              Export PDF summary
            </button>
            <button type="button" id="btnReset" class="btn-secondary" data-testid="reset">
              Clear
            </button>
          </div>
        </form>

        <output
          id="result"
          class="result"
          role="status"
          aria-live="polite"
          data-testid="result"
          hidden
        ></output>
      </div>
    </aside>

    <!-- MAPS (BOTTOM) -->
    <section class="maps" aria-labelledby="maps-heading">
      <h2 id="maps-heading" class="section-title">Reference Maps &amp; Tools</h2>

      <article class="map-card" aria-labelledby="sb535-title">
        <h3 id="sb535-title" class="map-card__title">SB&nbsp;535 Disadvantaged Communities Map</h3>
        <p class="map-card__actions">
          <a href="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/"
             target="_blank" rel="noopener">üîé Open full screen (best on mobile)</a>
        </p>
        <iframe
          src="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/"
          title="SB 535 Disadvantaged Communities Map"
          loading="lazy"
        ></iframe>
      </article>

      <article class="map-card" aria-labelledby="capuc-title">
        <h3 id="capuc-title" class="map-card__title">Community Air Protection (CAP UC) Map</h3>
        <p class="map-card__actions">
          <a href="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2"
             target="_blank" rel="noopener">üîé Open full screen (best on mobile)</a>
        </p>
        <iframe
          src="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2"
          title="Community Air Protection (CAP UC) Map"
          loading="lazy"
        ></iframe>
      </article>

      <article class="map-card" aria-labelledby="sce-title">
        <h3 id="sce-title" class="map-card__title">SCE Shutoff (Outage Status) Tool</h3>
        <p class="map-card__actions">
          <a href="https://www.sce.com/outages-safety/outage-center/check-outage-status"
             target="_blank" rel="noopener">üîó Check Public Safety Shutoff Status</a>
        </p>
      </article>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <p>
      <small>
        Press <kbd>Enter</kbd> to calculate, <kbd>Esc</kbd> to clear. This tool is advisory only.
      </small>
    </p>
  </footer>

  <script>
    /************************************************************
     * CONFIG
     ************************************************************/
    const CONFIG = {
      geocodeUrl:
        "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates",

      // SB 535 Disadvantaged Communities 2022 (layer 0)
      sb535Url:
        "https://services1.arcgis.com/PCHfdHz4GlDNAhBb/ArcGIS/rest/services/SB_535_Disadvantaged_Communities_2022/FeatureServer/0/query",

      // CPUC Fire Threat Areas ‚Äì Tier 3 (0) & Tier 2 (1)
      wildfireTierUrls: [
        "https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/0/query",
        "https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/CPUC_Fire_Threat_Areas/FeatureServer/1/query"
      ],

      // Consolidated PSPS polygons (layer 0)
      pspsUrl:
        "https://services2.arcgis.com/VofPZYDe2pLxSP5G/arcgis/rest/services/Consolidated_PSPS_Map20221231_gdb/FeatureServer/0/query",

      // *** NEW: Program Administrator / Utility territories polygon ***
      // Replace with your real FeatureServer layer that contains a PA / utility name field
      paTerritoriesUrl:
        "https://services.arcgis.com/BLN4oKB0N1YSgvY8/ArcGIS/rest/services/SGIP_PA_Territories/FeatureServer/0/query",

      // Field in the PA layer that holds the PA / utility code you want (PGE, SCE, SDGE, SCG, LADWP, OTHER)
      paField: "UTILITY_CODE", // <-- change to match your schema

      // Program open dates
      openDates: {
        IOUs: "2025-05-20", // PG&E, SCE, SDG&E, SoCalGas
        LADWP: null         // later 2025
      },

      // HUD API
      hud: {
        apiKey: "",           // <<<------- PASTE YOUR HUD USER API KEY HERE
        year: 2024,
        baseZipUrl: "https://www.huduser.gov/hudapi/public/il/v2/zip"
      }
    };

    /************************************************************
     * Program constants
     ************************************************************/
    const RATES = {
      storagePerWh: 1.10,  // $/Wh (=$1,100/kWh)
      solarPerkW: 3100     // $/kW
    };
    const KW_PER_SQFT = 0.0035;
    const IOU_CODES = ["PGE", "SCE", "SDGE", "SCG"];

    /************************************************************
     * Helpers
     ************************************************************/
    const SELECTORS = {
      form: "#calcForm",
      result: "#result",
      btnReset: "#btnReset",
      btnExport: "#btnExport",
      btnCheck: "#btnCheck",

      addressInput: "#addressInput",
      checkAddressBtn: "#checkAddressBtn",
      clearAddressBtn: "#clearAddressBtn",
      addressStatus: "#addressStatus",
      inDAC: "#inDAC",
      inFire: "#inFire",
      inPSPS: "#inPSPS",
      miniMap: "#miniMap",

      utility: "#utility",
      utilityStatusPill: "#utilityStatusPill",
      utilityStatusText: "#utilityStatusText",
      waitlistBanner: "#waitlistBanner",

      // HUD
      hudZip: "#hudZip",
      hudHousehold: "#hudHousehold",
      hudIncome: "#hudIncome",
      hudFetchBtn: "#hudFetchBtn",
      hudStatus: "#hudStatus",
      amiPercent: "#amiPercent"
    };

    const qs = (sel, root = document) => root.querySelector(sel);
    const money = n => n.toLocaleString(undefined, { maximumFractionDigits: 0 });
    const money2 = n => n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const number1 = n => n.toLocaleString(undefined, { maximumFractionDigits: 1 });

    const ADDRESS_CACHE_KEY = "sgipAddressCache_v4";
    function loadCache() { try { return JSON.parse(localStorage.getItem(ADDRESS_CACHE_KEY)) || {}; } catch { return {}; } }
    function saveCache(cache) { try { localStorage.setItem(ADDRESS_CACHE_KEY, JSON.stringify(cache)); } catch {} }
    const addressCache = loadCache();

    function todayISO() { return new Date().toISOString().slice(0,10); }
    function isAfterOrEqual(dateISO1, dateISO2) { return new Date(dateISO1) >= new Date(dateISO2); }

    function setUtilityStatus(utilityCode) {
      const pill = qs(SELECTORS.utilityStatusPill);
      const text = qs(SELECTORS.utilityStatusText);
      const calcBtn = qs(SELECTORS.btnCheck);
      const exportBtn = qs(SELECTORS.btnExport);
      const waitlistBanner = qs(SELECTORS.waitlistBanner);

      pill.className = "status-pill";
      text.textContent = "";

      const today = todayISO();
      let open = false;
      let pending = false;

      if (IOU_CODES.includes(utilityCode)) {
        if (isAfterOrEqual(today, CONFIG.openDates.IOUs)) open = true; else pending = true;
      } else if (utilityCode === "LADWP") {
        pending = true;
      } else if (utilityCode === "OTHER") {
        open = true;
      } else {
        pending = true;
      }

      if (open) {
        pill.textContent = "OPEN";
        pill.classList.add("status-open");
        if (IOU_CODES.includes(utilityCode)) {
          text.innerHTML = ` Opens: May 20, 2025 (now accepting).`;
          waitlistBanner.classList.remove("hidden");
        } else if (utilityCode === "OTHER") {
          text.textContent = ` Check your program administrator for openings.`;
          waitlistBanner.classList.add("hidden");
        }
        calcBtn.disabled = false;
        exportBtn.disabled = true;
      } else if (pending) {
        pill.textContent = "PENDING";
        pill.classList.add("status-pending");
        if (IOU_CODES.includes(utilityCode)) {
          text.innerHTML = ` Opens May 20, 2025.`;
        } else if (utilityCode === "LADWP") {
          text.innerHTML = ` LADWP opens later in 2025.`;
        } else {
          text.innerHTML = ` Select / detect a utility to continue.`;
        }
        calcBtn.disabled = true;
        exportBtn.disabled = true;
        waitlistBanner.classList.add("hidden");
      } else {
        pill.textContent = "CLOSED";
        pill.classList.add("status-closed");
        text.textContent = ` Not accepting applications.`;
        calcBtn.disabled = true;
        exportBtn.disabled = true;
        waitlistBanner.classList.add("hidden");
      }
    }

    function validate(form) {
      let valid = true;

      const customerType = form.customerType;
      const customerTypeError = qs("#customerType-error");
      if (!customerType.value) {
        customerTypeError.hidden = false;
        customerTypeError.textContent = "Please select a customer type.";
        valid = false;
      } else {
        customerTypeError.hidden = true;
        customerTypeError.textContent = "";
      }

      const capacity = parseFloat(form.capacity.value);
      const capacityError = qs("#capacity-error");
      if (isNaN(capacity) || capacity <= 0) {
        capacityError.hidden = false;
        capacityError.textContent = "Please provide a valid storage capacity (kWh).";
        valid = false;
      } else {
        capacityError.hidden = true;
        capacityError.textContent = "";
      }
      return valid;
    }

    function equityEligibilityReason({ amiPercent, careProgram, inDAC }) {
      if (typeof amiPercent === "number" && !isNaN(amiPercent) && amiPercent <= 80) return "Income ‚â§ 80% AMI";
      if (careProgram === true) return "Participating in CARE/FERA/ESA";
      if (inDAC === true) return "Located in a Disadvantaged Community (SB 535)";
      return null;
    }

    function calculate(payload) {
      const {
        squareFootage,
        capacityInput,
        solarCapacityInput,
        amiPercent,
        careProgram,
        inDAC,
        utilityCode
      } = payload;

      let capacity = parseFloat(capacityInput) || 15;
      if (capacity <= 0) capacity = 15;

      let solarCap = parseFloat(solarCapacityInput) || 0;
      let autoPvKwUsed = null;

      if (!solarCap && squareFootage > 0) {
        autoPvKwUsed = Math.max(1, squareFootage * KW_PER_SQFT);
        solarCap = parseFloat(autoPvKwUsed.toFixed(1));
      }

      const storageIncentive = capacity * 1000 * RATES.storagePerWh;
      const solarIncentive = solarCap * RATES.solarPerkW;
      const totalIncentive = storageIncentive + solarIncentive;

      const reason = equityEligibilityReason({ amiPercent, careProgram, inDAC });
      const equityEligible = !!reason;

      const possibleWaitlist = IOU_CODES.includes(utilityCode);

      let explanation = `
<strong>SGIP Residential Solar & Storage Equity ‚Äì Estimated Incentive</strong>

<strong>Program status</strong>
‚Ä¢ Utility: ${utilityCode || "‚Äî"}  
‚Ä¢ ${possibleWaitlist ? "‚ö†Ô∏è Possible waitlist due to high demand." : "Status will vary by PA"}  

<strong>Your eligibility (auto-evaluated)</strong>
‚Ä¢ Equity-eligible: ${equityEligible ? "Yes" : "No"}${equityEligible ? ` (Reason: ${reason})` : ""}  
‚Ä¢ AMI %: ${typeof amiPercent === "number" && !isNaN(amiPercent) ? amiPercent.toFixed(1) + "%" : "not provided"}  
‚Ä¢ CARE/FERA/ESA: ${careProgram ? "Yes" : "No/Unknown"}  
‚Ä¢ DAC: ${inDAC ? "Yes" : "No"}  

<strong>Your inputs / assumptions</strong>
‚Ä¢ Storage: ${number1(capacity)}‚ÄØkWh ‚Üí $${money(storageIncentive)} @ $${money2(RATES.storagePerWh)} /Wh  
${solarCap > 0 ? `‚Ä¢ Solar: ${number1(solarCap)}‚ÄØkW ‚Üí $${money(solarIncentive)} @ $${money(RATES.solarPerkW)} /kW  ` : ""}${
autoPvKwUsed !== null
  ? `\n‚Ä¢ PV size estimated from ${squareFootage.toLocaleString()}‚ÄØft¬≤ @ 0.0035‚ÄØkW/ft¬≤`
  : ""
}

<strong>Total SGIP incentives (est.): $${money(totalIncentive)}</strong>

<strong>Advanced Payment</strong>
‚Ä¢ You may be able to receive **50% upfront** through the SGIP Advanced Payment option, reducing out-of-pocket costs until project completion.

<strong>Disclaimers</strong>
‚Ä¢ This is a planning tool only; confirm final eligibility, rates, and program status with your SGIP Program Administrator.  
‚Ä¢ Incentive rates and budgets can change; applications may be waitlisted once funds are fully subscribed.
`;

      return { explanation };
    }

    /* ---------- HUD API ---------- */
    async function fetchHudAMIByZip(zip, year, apiKey) {
      if (!apiKey) throw new Error("No HUD API key configured in CONFIG.hud.apiKey");
      const url = `${CONFIG.hud.baseZipUrl}/${zip}?year=${year}`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${apiKey}` } });
      if (!res.ok) throw new Error(`HUD API error: ${res.status}`);
      const json = await res.json();
      return json;
    }

    function computeAmiPercentFromHudResponse(json, income) {
      const d = json?.data?.[0];
      if (!d || typeof d.medianFamilyIncome !== "number") {
        throw new Error("Could not find Median Family Income in HUD response.");
      }
      const mfi = d.medianFamilyIncome;
      return (income / mfi) * 100;
    }

    /* ---------- ArcGIS helpers ---------- */
    async function geocodeAddress(address) {
      const params = new URLSearchParams({
        SingleLine: address,
        outFields: "Match_addr,Addr_type",
        f: "json",
      });

      const url = `${CONFIG.geocodeUrl}?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Geocoding failed");
      const json = await res.json();

      const candidate = (json.candidates || [])[0];
      if (!candidate) throw new Error("No match found");
      return {
        x: candidate.location.x,
        y: candidate.location.y,
        score: candidate.score,
        matchAddress: candidate.address,
      };
    }

    async function pointInLayer({ x, y }, layerQueryUrl) {
      const params = new URLSearchParams({
        f: "json",
        geometry: JSON.stringify({ x, y, spatialReference: { wkid: 4326 } }),
        geometryType: "esriGeometryPoint",
        inSR: "4326",
        spatialRel: "esriSpatialRelIntersects",
        outFields: "*",
        returnGeometry: "false",
      });

      const res = await fetch(`${layerQueryUrl}?${params.toString()}`);
      if (!res.ok) throw new Error(`Layer query failed: ${res.status} ${layerQueryUrl}`);
      const json = await res.json();
      return (json.features || []).length > 0 ? json.features[0] : null;
    }

    async function pointInAnyLayer(point, urls) {
      for (const url of urls) {
        const f = await pointInLayer(point, url);
        if (f) return f;
      }
      return null;
    }

    async function detectUtilityFromPoint(point) {
      if (!CONFIG.paTerritoriesUrl) return null;

      const params = new URLSearchParams({
        f: "json",
        geometry: JSON.stringify({ x: point.x, y: point.y, spatialReference: { wkid: 4326 } }),
        geometryType: "esriGeometryPoint",
        inSR: "4326",
        spatialRel: "esriSpatialRelIntersects",
        outFields: "*",
        returnGeometry: "false"
      });

      const url = `${CONFIG.paTerritoriesUrl}?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`PA boundary query failed: ${res.status}`);
      const json = await res.json();
      const feat = json.features?.[0];
      if (!feat) return null;

      const code = feat.attributes?.[CONFIG.paField];
      return code || null;
    }

    /* ---------- tiny map ---------- */
    let miniMap;
    let miniMarker;
    function updateMiniMap(lat, lon) {
      const el = qs(SELECTORS.miniMap);
      el.classList.remove("hidden");

      if (!miniMap) {
        miniMap = L.map(el).setView([lat, lon], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(miniMap);
        miniMarker = L.marker([lat, lon]).addTo(miniMap);
      } else {
        miniMap.setView([lat, lon], 14);
        if (miniMarker) miniMarker.setLatLng([lat, lon]); else miniMarker = L.marker([lat, lon]).addTo(miniMap);
      }
    }

    function setAddressStatus(message, badges = []) {
      const box = qs(SELECTORS.addressStatus);
      box.innerHTML = `
        ${badges.map(b => `<span class="badge">${b}</span>`).join(" ")}
        ${message}
      `;
      box.classList.remove("hidden");
    }

    function exportPDF(html) {
      const w = window.open("", "_blank");
      w.document.write(`
        <html>
          <head>
            <title>SGIP Incentive Summary</title>
            <meta charset="utf-8" />
            <style>
              body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 24px; color: #111; }
              h1 { font-size: 1.5rem; margin-bottom: 1rem; color: #003c71; }
              .section { margin-bottom: 1.25rem; }
              .muted { color: #666; font-size: 0.875rem; margin-top: 2rem; }
              strong { color: #003c71; }
            </style>
          </head>
          <body>
            <h1>SGIP Incentive Summary</h1>
            <div class="section">
              ${html}
            </div>
            <div class="muted">
              This summary is advisory only. Confirm eligibility, rates, and program status with your Program Administrator.
            </div>
          </body>
        </html>
      `);
      w.document.close();
      w.focus();
      w.print();
    }

    /************************************************************
     * DOM glue
     ************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      const form = qs(SELECTORS.form);
      const resultEl = qs(SELECTORS.result);
      const resetBtn = qs(SELECTORS.btnReset);
      const exportBtn = qs(SELECTORS.btnExport);
      const calcBtn = qs(SELECTORS.btnCheck);

      const utilitySelect = qs(SELECTORS.utility);
      const addressInput = qs(SELECTORS.addressInput);
      const checkBtn = qs(SELECTORS.checkAddressBtn);
      const clearBtn = qs(SELECTORS.clearAddressBtn);
      const statusBox = qs(SELECTORS.addressStatus);

      const inDACSelect = qs(SELECTORS.inDAC);
      const inFireSelect = qs(SELECTORS.inFire);
      const inPSPSSelect = qs(SELECTORS.inPSPS);

      const hudZip = qs(SELECTORS.hudZip);
      const hudHousehold = qs(SELECTORS.hudHousehold);
      const hudIncome = qs(SELECTORS.hudIncome);
      const hudFetchBtn = qs(SELECTORS.hudFetchBtn);
      const hudStatus = qs(SELECTORS.hudStatus);
      const amiPercentInput = qs(SELECTORS.amiPercent);

      // Initialize
      setUtilityStatus("");

      utilitySelect.addEventListener("change", () => {
        setUtilityStatus(utilitySelect.value);
      });

      // HUD AMI auto-fill
      hudFetchBtn.addEventListener("click", async () => {
        hudStatus.textContent = "";
        const zip = hudZip.value.trim();
        const hhSize = parseInt(hudHousehold.value, 10);
        const income = parseFloat(hudIncome.value);

        if (!zip || zip.length !== 5) { hudStatus.textContent = "Please enter a 5-digit ZIP code."; return; }
        if (!hhSize || hhSize <= 0)   { hudStatus.textContent = "Please enter a valid household size."; return; }
        if (isNaN(income) || income <= 0) { hudStatus.textContent = "Please enter a valid annual household income."; return; }

        try {
          hudStatus.textContent = "Fetching HUD income limits...";
          const json = await fetchHudAMIByZip(zip, CONFIG.hud.year, CONFIG.hud.apiKey);
          const pct = computeAmiPercentFromHudResponse(json, income);
          amiPercentInput.value = pct.toFixed(1);
          hudStatus.textContent = `Estimated AMI% = ${pct.toFixed(1)}%. (income √∑ MFI √ó 100)`;
        } catch (e) {
          console.error(e);
          hudStatus.textContent = `HUD lookup failed: ${e.message}`;
        }
      });

      // Address checks (now also auto-detect utility)
      checkBtn.addEventListener("click", async () => {
        const raw = addressInput.value.trim();
        if (!raw) {
          setAddressStatus("Please enter an address first.");
          return;
        }
        const address = raw.toLowerCase();

        // From cache?
        if (addressCache[address]) {
          const c = addressCache[address];
          setAddressStatus(
            `[cached]\nUtility: ${c.utility || "‚Äî"}\nDAC: ${c.dac ? "Yes" : "No"} ‚Ä¢ Fire Tier 2/3: ${c.fire ? "Yes" : "No"} ‚Ä¢ PSPS: ${c.psps ? "Yes" : "No"}\n(${c.lat.toFixed(5)}, ${c.lon.toFixed(5)})`,
            [
              c.utility || "",
              c.dac ? "DAC" : "",
              c.fire ? "Tier 2/3" : "",
              c.psps ? "PSPS" : ""
            ].filter(Boolean)
          );
          inDACSelect.value = c.dac ? "yes" : "no";
          inFireSelect.value = c.fire ? "yes" : "no";
          inPSPSSelect.value = c.psps ? "yes" : "no";
          if (c.utility) {
            utilitySelect.value = c.utility;
            setUtilityStatus(c.utility);
          }
          updateMiniMap(c.lat, c.lon);
          return;
        }

        setAddressStatus("Geocoding address...");
        try {
          const point = await geocodeAddress(raw);
          const lat = point.y;
          const lon = point.x;

          setAddressStatus("Checking DAC / Fire / PSPS layers...");
          const [dacFeature, fireFeature, pspsFeature] = await Promise.all([
            CONFIG.sb535Url ? pointInLayer(point, CONFIG.sb535Url) : null,
            CONFIG.wildfireTierUrls?.length ? pointInAnyLayer(point, CONFIG.wildfireTierUrls) : null,
            CONFIG.pspsUrl ? pointInLayer(point, CONFIG.pspsUrl) : null,
          ]);

          const dac = !!dacFeature;
          const fire = !!fireFeature;
          const psps = !!pspsFeature;

          inDACSelect.value = dac ? "yes" : "no";
          inFireSelect.value = fire ? "yes" : "no";
          inPSPSSelect.value = psps ? "yes" : "no";

          // Auto-detect PA / Utility
          let utilDetected = null;
          if (CONFIG.paTerritoriesUrl) {
            setAddressStatus("Detecting Program Administrator / Utility territory...");
            try {
              utilDetected = await detectUtilityFromPoint(point);
              if (utilDetected) {
                utilitySelect.value = utilDetected;
                setUtilityStatus(utilDetected);
              }
            } catch (e) {
                console.warn("PA detection failed:", e);
            }
          }

          const badges = [];
          if (utilDetected) badges.push(utilDetected);
          if (dac) badges.push("DAC");
          if (fire) badges.push("Tier 2/3");
          if (psps) badges.push("PSPS");

          setAddressStatus(
            `Found coordinates: (${lat.toFixed(5)}, ${lon.toFixed(5)})\nUtility: ${utilDetected || "‚Äî"}\nDAC: ${dac ? "Yes" : "No"} ‚Ä¢ Fire Tier 2/3: ${fire ? "Yes" : "No"} ‚Ä¢ PSPS: ${psps ? "Yes" : "No"}.`,
            badges
          );

          updateMiniMap(lat, lon);

          addressCache[address] = { utility: utilDetected, dac, fire, psps, lat, lon, ts: Date.now() };
          saveCache(addressCache);
        } catch (err) {
          console.error(err);
          setAddressStatus(
            "Address eligibility check failed.\n" +
            "‚Ä¢ Step that failed: " + (err.message || err) + "\n" +
            "‚Ä¢ Tip: Verify your ArcGIS layer URLs (CONFIG.*Url) and network console."
          );
        }
      });

      clearBtn.addEventListener("click", () => {
        addressInput.value = "";
        statusBox.classList.add("hidden");
        statusBox.innerHTML = "";
        qs(SELECTORS.miniMap).classList.add("hidden");
        inDACSelect.value = "";
        inFireSelect.value = "";
        inPSPSSelect.value = "";
      });

      // Calculate
      form.addEventListener("submit", e => {
        e.preventDefault();

        const util = utilitySelect.value;
        const utilOpen =
          (IOU_CODES.includes(util) && isAfterOrEqual(todayISO(), CONFIG.openDates.IOUs)) ||
          (util === "OTHER");

        if (!utilOpen) {
          alert("Your selected utility is not open yet for SGIP Residential Solar & Storage Equity.");
          return;
        }

        if (!validate(form)) {
          resultEl.hidden = true;
          return;
        }

        const amiValRaw = form.amiPercent.value.trim();
        const amiPercent = amiValRaw === "" ? null : Number(amiValRaw);
        const careProgram = form.careProgram.value === "yes";

        const payload = {
          utilityCode: util,
          squareFootage: parseFloat(form.squareFootage.value) || 0,
          capacityInput: form.capacity.value,
          solarCapacityInput: form.solarCapacity.value,
          amiPercent: typeof amiPercent === "number" && !isNaN(amiPercent) ? amiPercent : null,
          careProgram,
          inDAC: form.inDAC.value === "yes"
        };

        const out = calculate(payload);

        resultEl.innerHTML = out.explanation;
        resultEl.hidden = false;

        exportBtn.disabled = false;
        resultEl.scrollIntoView({ behavior: "smooth", block: "start" });
      });

      exportBtn.addEventListener("click", () => {
        if (!resultEl.hidden) {
          exportPDF(resultEl.innerHTML);
        }
      });

      resetBtn.addEventListener("click", () => {
        form.reset();
        resultEl.hidden = true;
        exportBtn.disabled = true;
        qs(SELECTORS.btnCheck).disabled = true;
        setUtilityStatus("");
      });

      document.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          form.reset();
          resultEl.hidden = true;
          exportBtn.disabled = true;
          qs(SELECTORS.btnCheck).disabled = true;
          setUtilityStatus("");
        }
      });
    });
  </script>
</body>
</html>
